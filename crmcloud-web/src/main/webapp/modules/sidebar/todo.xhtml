<?xml version='1.0' encoding='UTF-8' ?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
    <c:forEach items="#{issueTodoController.list}" var="todo" varStatus="loop">
    <li class="todo-item">
        <h:commandLink target="_blank" actionListener="#{issueController.show(todo.todoIssueId.issueId)}"
            action="#{issueController.outcome(todo.todoIssueId.issueId)}"
            disabled="#{not (sec.isMaster() or sec.hasMethod('IssueController', 'view'))}">
            <f:param name="force" value="true"/>
            <f:param name="id" value="#{todo.todoIssueId.issueId}" />
            <f:param name="issueActiveTab" value="#tabViewIssue:tabViewTodoList" />
            <h4 title="#{msg['label.show']}">
                #{todo.todoIssueId.issueViewCode}
                <span class="time-elapsed" ref="#{todo.todoIntendedDatetime.time}"></span>
            </h4>
            <h5><span class="pull-right label label-default">#{todo.todoImportantLevel.getItemViewData(localeController.locale)}</span></h5>
            <p><h:outputText value="#{todo.todoContent}" /></p>
        </h:commandLink>
        <p:commandLink onstart="start()" onsuccess="finish()" oncomplete="$('.reload-todo-list').trigger('click')"
            actionListener="${issueTodoController.updateStatus(todo.todoId, 0)}"
            update="@(.panelGrid_todos)"
            styleClass="hide toggle-click-off"/>
        <p:commandLink onstart="start()" onsuccess="finish()" oncomplete="$('.reload-todo-list').trigger('click')"
            actionListener="${issueTodoController.updateStatus(todo.todoId, 1)}"
            update="@(.panelGrid_todos)"
            styleClass="hide toggle-click-on"/>
        <div class="button-toggles toggle-light" data-toggle-on="#{todo.done ? 'true': 'false'}" data-toggle-height="15" data-toggle-width="40" title="#{msg['label.state']}"></div>
    </li>
    </c:forEach>
    <c:if test="#{issueTodoController.list.size() eq 0}">
        <li><h6 class="text-warning text-center"><i>#{msg['label.data.empty']}</i></h6></li>
    </c:if>
    <h:outputScript>
        //<![CDATA[
        jQuery(document).ready(function($){
            $("#sidebar .todo-item .time-elapsed").each(function(e){
                var t = $(this).attr("ref"); 
                var self = $(this);
                var endTime = moment(t, "x");
                var text = endTime.fromNow();
                self.text(text);
                var time = endTime.format('YYYY/MM/DD HH:mm');
                self.parent().parent().find("h5").append(time);
                var d = endTime.diff(moment(), 'days');
                if(d < 0){
                    self.addClass("label label-danger");
                }else if(d <= 3){
                    self.addClass("label label-warning");
                }else{
                    self.addClass("label label-success");
                }
            });

            $('#sidebar .todo-item .button-toggles').toggles({text:{on:'#{msg['label.short_complete']}',off:'#{msg['label.short_incomplete']}'}})
                .on('toggle', function(e, active) {
                    var parent = $(this).closest('.todo-item');
                    if (active) {
                        parent.find('.toggle-click-on').trigger('click');
                    } else {
                        parent.find('.toggle-click-off').trigger('click');
                    }
                });
        });
        //]]>
    </h:outputScript>
</ui:composition>

