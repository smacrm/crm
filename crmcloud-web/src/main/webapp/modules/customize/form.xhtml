<?xml version='1.0' encoding='UTF-8' ?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:fn="http://java.sun.com/jsp/jstl/functions"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
    <h:outputStylesheet library="formbuilder" name="form-builder.css"/>
    <h:outputFormat rendered="#{empty customizeController.selectedPage.pageId}">
        <div id="pageTitle">#{customize['label.page.title']} #{msg['symbol.paren.left']}#{msg['label.create']}#{msg['symbol.paren.right']}</div>
    </h:outputFormat>
    <h:outputFormat rendered="#{not empty customizeController.selectedPage.pageId}">
        <div id="pageTitle">#{customize['label.page.title']} #{msg['symbol.paren.left']}#{msg['label.edit']}#{msg['symbol.paren.right']}</div>
    </h:outputFormat>
    <h:form onkeypress="if (event.keyCode === 13 &amp;&amp; $(event.target).prop('tagName') !== 'TEXTAREA') { return false; }">
        <h:panelGrid width="100%" styleClass="page-header">
            <f:facet name="header">
                <!-- Content Header (Page header) -->
                <div class="row">
                    <div class="col-md-6">
                        <h1>
                            #{customize['label.page.title']}
                            <small>#{customize['label.page.description']}</small>
                        </h1>
                    </div>
                    <div class="col-md-6 text-right">
                        <p:commandButton value="#{msg['label.back']}" icon="fa fa-chevron-circle-left" actionListener="#{customizeController.reload()}" 
                                         process="@this" update="mainContent" onstart="start()" onsuccess="finish()">
                            <p:confirm header="#{msg['label.confirm']}" message="#{msg['label.message.confirm.back']}" icon="ui-icon-alert"/>
                            <f:param name="force" value="true"/>
                        </p:commandButton>
                        <p:commandButton value="#{msg['label.delete']}" actionListener="#{customizeController.remove(customizeController.selectedPage)}" 
                                         icon="fa fa-trash" update="mainContent, :growl, :sidebarLeft:menuListGroup, :sidebarLeft:menuSearchGroup, :sidebarLeft:issueLamp" 
                                         onstart="start()" onsuccess="finish()"
                                         rendered="#{not empty customizeController.selectedPage.pageId and sec.hasMethod('CustomizeController', 'delete')}">
                            <p:confirm header="#{msg['label.confirm']}" message="#{msg['label.confirm.delete']}" icon="ui-icon-alert" />
                            <f:param name="force" value="true"/>
                        </p:commandButton>
                        <p:commandButton value="#{msg['label.save']}" type="button" icon="fa fa-check-circle" styleClass="customize-save"/>
                        <p:commandLink actionListener="#{customizeController.saveFormBuilder()}" style="display:none" 
                                       styleClass="customize-save-action" onstart="start()" onsuccess="finish()" update="mainContent, :growl, :sidebarLeft:menuListGroup, :sidebarLeft:menuSearchGroup, :sidebarLeft:issueLamp">
                            <f:param name="force" value="true"/>
                        </p:commandLink>
                        
                        <p:outputPanel styleClass="ui-groupbutton" rendered="#{not empty customizeController.selectedPage.pageId}">
                            <p:commandButton title="#{msg['label.previous']}" icon="fa fa-angle-left" styleClass="btn btn-default"
                                             update=":growl, mainContent"
                                             disabled="#{customizeController.itemViewIndex le 0}"
                                             actionListener="#{customizeController.showUpdateFormByIndex(customizeController.itemViewIndex-1)}"/>
                            <p:commandButton value="#{customizeController.itemViewIndex+1}/#{customizeController.pageList.size()}" styleClass="ui-corner-none"/>
                            <p:commandButton title="#{msg['label.next']}" icon="fa fa-angle-right" styleClass="ui-corner-right" 
                                             update=":growl, mainContent"
                                             disabled="#{customizeController.itemViewIndex + 1 ge customizeController.pageList.size()}"
                                             actionListener="#{customizeController.showUpdateFormByIndex(customizeController.itemViewIndex+1)}"/>
                        </p:outputPanel>
                        <p:commandButton value="#{msg['label.print']}" title="#{msg['label.print']}" icon="fa fa-print" 
                                         rendered="#{not empty customizeController.selectedPage.pageId}">
                            <p:printer target="printArea"/>
                        </p:commandButton>
                    </div>
                </div>
                <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                    <p:commandButton value="#{msg['label.yes']}" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
                    <p:commandButton value="#{msg['label.no']}" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
                </p:confirmDialog>
            </f:facet>
        </h:panelGrid>
        <p:outputPanel id="printArea" styleClass="box">
            <div class="box-body" style="min-height: 500px;">
                <h:inputTextarea value="#{customizeController.autoFormContent}" styleClass="autoFormContent" style="display: none"/>
                <table class="table">
                    <tbody>
                        <tr>
                            <td width="120">
                                <p:outputLabel value="#{customize['label.table.name']}"/>
                            </td>
                            <td colspan="3" valign="center">
                                <h:outputLabel value="#{customizeController.staticPageLabel[customizeController.selectedPage.pageId.toString()]}"/>
                                <h:outputLabel value="#{customizeController.staticPageLabel[customizeController.selectedPage.pageName]}"/>
                                <p:selectOneMenu id="pageName" styleClass="pageName hide" value="#{customizeController.selectedPage.pageName}" onkeyup="onKeyUp()"
                                                 editable="false" widgetVar="pagename" style="width: 50%;" required="true" label="#{customize['label.table.name']}">
                                    <c:if test="#{not empty customizeController.selectedPage.pageType and not customizeController.selectedPage.dynamic}">
                                        <f:selectItem itemLabel="#{customizeController.selectedPage.pageName}" itemValue="#{customizeController.selectedPage.pageName}" rendered="#{not customizeController.selectedPage.dynamic}"/>
                                    </c:if>
                                    <f:selectItems value="#{customizeController.staticPages.entrySet()}" var="entry" itemValue="#{entry.value}" itemLabel="#{entry.key}" itemDisabled="#{customizeController.isDisable(entry.value)}"/>
                                    <f:attribute name="title" value="#{customize['label.table.name']}"/>
                                </p:selectOneMenu>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div id="form-builder-pages" class="customize-form">
                    <ul id="tabs">
                        <li id="add-page-tab"><a href="#new-page">+ #{customize['label.tab']}</a></li>
                    </ul>
                    <div id="new-page"></div>
                </div>
            </div>
        </p:outputPanel>
        <script type="text/javascript">
            jQuery(document).ready(function(){
                $('#ui-datepicker-div').remove(); // fix bug #6179
                /*
                var inputField = $(".pageName input.ui-inputfield");
                var selectField = $(".pageName select");
        
                var orgValue = '#{customizeController.selectedPage.pageName}';
                PF('pagename').selectValue(orgValue);
                
                var orgText = inputField.val().trim();
                var timer = false;
                inputField.keyup(function(e){
                    if(timer) clearTimeout (timer);
                    timer = setTimeout(function(){
                        var newText = inputField.val().trim();
                        if(newText === orgText){
                            PF('pagename').selectValue(orgValue);
                        }else{
                            var value = false;
                            selectField.find('option').each(function(){
                                if($(this).text().trim() === newText){
                                    value = $(this).attr('value');
                                    return false;
                                }
                            });
                            if(value === false){
                                selectField.find('option[selected="selected"]').prop('selected', false);
                            }else{
                                PF('pagename').selectValue(value);
                            }
                        }
                        clearTimeout (timer);
                        timer = false;
                    }, 400 );
                });
                */
            });
        </script>
        <script type="text/javascript">
            
            var rootOptions = {
                dynamicOptions: {
                    'd_o_group': '#{msg['label.menu.GroupController']}',
                    'd_o_user': '#{msg['label.menu.MemberController']}',
                    <c:forEach items="${maintenanceController.staticColumnsData}" var="item">
                        '${item}': '#{issue['label.'.concat(item.replaceAll('cust_tel_session_id','session').replaceAll('_id', '_name'))]}',
                    </c:forEach>
                   <c:forEach items="${maintenanceController.dynamicColumnRoot}" var="item">
                    '${item}': '#{msg['label.'.concat(item)]}',
                    </c:forEach>
                },
            }
        </script>
        <h:outputScript library="plugins" name="jQueryUI/jquery-ui.min.js"/>
        <h:outputStylesheet library="plugins" name="multipleselect/jquery.multiselect.css"/>
        <h:outputScript library="plugins" name="multipleselect/jquery.multiselect.min.js"/>
        <h:outputScript library="plugins" name="multipleselect/jquery.multiselect.#{localeController.locale}.js"/>
        <h:outputScript library="formbuilder" name="form-builder.js"/>
        <h:outputScript library="formbuilder" name="langs/#{localeController.locale}.js"/>
        <h:outputScript library="js" name="customize.js"/>
    </h:form>
</ui:composition>
