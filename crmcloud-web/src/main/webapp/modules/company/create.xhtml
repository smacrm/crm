<?xml version='1.0' encoding='UTF-8' ?>
<ui:composition
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:p="http://primefaces.org/ui"
    xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:h="http://xmlns.jcp.org/jsf/html">
    <div id="pageTitle">#{companyBundle['label.company.header']} #{msg['symbol.paren.left']}#{companyBundle['label.company.header.create']}#{msg['symbol.paren.right']}</div>
    <style type="text/css">
        div.union-company-overlay > div.ui-overlaypanel-content {
            overflow-x: hidden;
            height: 198px;
            overflow-y: auto;
        }
    </style>
    <h:form id="frmCompany">
        <h:panelGrid width="100%" styleClass="page-header">
            <f:facet name="header">
                <div class="row">
                    <div class="col-md-6">
                        <h1>
                            #{companyBundle['label.company.header']}
                            <small>#{companyBundle['label.company.header.create']}</small>
                        </h1>
                    </div>
                    <div class="col-md-6 text-right">
                        <p:commandButton value="#{msg['label.back']}" icon="fa fa-chevron-circle-left" actionListener="#{companyController.load}"
                                         title="#{msg['label.back']}" update="mainContent" process="@this"
                                         onstart="start()" onsuccess="finish()">
                            <p:confirm header="#{msg['label.confirm']}" message="#{msg['label.message.confirm.back']}" icon="ui-icon-alert"/>
                            <f:param name="force" value="true"/>
                        </p:commandButton>
                        <p:commandButton value="#{msg['label.save']}" icon="fa fa-check-circle"
                                         actionListener="#{companyController.save}"
                                         rendered="${sec.hasMethod('CompanyController', 'create')}"
                                         title="#{msg['label.save']}" update="frmCompany mainContent :growl"
                                         onstart="start()" onsuccess="finish()">
                            <f:param name="force" value="true"/>
                        </p:commandButton>
                        <p:commandButton value="#{companyBundle['label.company.left_group']}" actionListener="#{companyController.leftGroup}"
                                         title="#{companyBundle['label.company.left_group']}"
                                         update="groupFromCompanyId,btnSetGroupCompany,panelSetGroupCompany"
                                         process="@this"
                                         rendered="#{sec.master}"
                                         onstart="start()" onsuccess="finish()">
                        </p:commandButton>
                        <p:remoteCommand name="resetPanelCompanyGroups" update="groupFromCompanyId,btnSetGroupCompany,panelSetGroupCompany" />
                    </div>
                </div>
            </f:facet>
        </h:panelGrid>
        <div class="box">
            <div class="box-body">
                <p:panelGrid styleClass="crmcloud-panelgrid">
                    <p:row rendered="#{sec.master}">
                        <p:column styleClass="label-field"><p:outputLabel value="#{companyBundle['label.company.twofactor']}"/></p:column>
                        <p:column><p:selectBooleanCheckbox value="#{companyController.companyModel.company.usingTwoFactor}"/></p:column>
                        <p:column styleClass="label-field">#{companyBundle['label.company_db_server']}</p:column>
                        <p:column>
                            <p:selectOneMenu
                                value="#{companyController.companyModel.company.databaseServerId}"
                                id="dbServerCbx">
                                <p:ajax event="change"
                                        listener="#{dbServerController.onSelectChanged}"
                                        update=":dbServerManagerPanel"
                                        onstart="start()" onsuccess="finish()"
                                        oncomplete="if(args.isOpenDailog) { PF('dbServerManager').show(); }" />
                                <f:selectItems value="#{companyController.databaseServers}" var="ds" itemValue="#{ds.databaseServerId}" itemLabel="#{ds.databaseServerName}"/>
                                <f:selectItem itemValue="0" itemLabel="#{companyBundle['label.company_db_server']}#{msg['label.create']}" />
                            </p:selectOneMenu>
                        </p:column>
                    </p:row>
                    <p:row rendered="#{sec.master}">
                        <p:column styleClass="label-field"><p:outputLabel value="#{companyBundle['label.company.group']}" /></p:column>
                        <p:column style="width: 35%;">
                            <table style="width: 100%;">
                                <tr>
                                    <td><p:outputLabel value="#{companyController.displayUnionCompany}" id="groupFromCompanyId"/></td>
                                    <td>
                                        <p:commandButton id="btnSetGroupCompany" value="#{companyBundle['label.company.add']}" type="button" style="float: right;"/>
                                        <p:overlayPanel id="panelSetGroupCompany" for="btnSetGroupCompany" hideEffect="fade"
                                                        style="width: 24%; height: 200px;" showCloseIcon="false" styleClass="union-company-overlay"
                                                        my="right top" at="right bottom">
                                            <p:dataTable var="ucrm" value="#{companyController.unionCompanyRelModels}"
                                                         selectionMode="single" rowKey="#{ucrm.companyUnionKey}" id="datatableUCRM"
                                                         selection="#{companyController.companyRelModelSelected}"
                                                         style="margin-left: -13px; margin-right: -13px; margin-top: -7px; margin-bottom: -7px;">
                                                <p:ajax event="rowSelect" listener="#{companyController.onUnionCompanySelect}"
                                                        update="frmCompany:groupFromCompanyId,frmCompany:datatableUCRM"
                                                        onstart="start()" onsuccess="finish()"/>
                                                <p:column rendered="#{((not empty ucrm.displayGroup) and (!ucrm.ids.contains(companyController.companyModel.company.companyId)))}">
                                                    <h:outputText value="#{ucrm.displayGroup}"/>
                                                </p:column>
                                            </p:dataTable>
                                        </p:overlayPanel>
                                    </td>
                                </tr>
                            </table>
                        </p:column>
                        <p:column styleClass="label-field"><p:outputLabel value="#{companyBundle['label.company.bussiness']}" /></p:column>
                        <p:column>
                            <p:selectOneMenu value="#{companyController.companyModel.company.companyBusinessFlag}" >
                                <f:selectItems value="#{companyController.companyModel.businessTypes}"/>
                            </p:selectOneMenu>
                        </p:column>
                    </p:row>
                    <p:row>
                        <p:column styleClass="label-field"><p:outputLabel value="#{companyBundle['label.company.name']}" styleClass="required"/></p:column>
                        <p:column>
                            <p:inputText value="#{companyController.companyModel.company.companyName}" styleClass="input_text_name noupdate" 
                                         maxlength="80" required="true" label="#{companyBundle['label.company.name']}">
                                <f:validator validatorId="gnext.validator.RequiredValidator" />
                                <f:validator validatorId="gnext.validator.LengthValidator" />
                                <f:attribute name="max" value="80"/>
                                <f:attribute name="title" value="#{companyBundle['label.company.name']}"/>
                            </p:inputText>
                        </p:column>
                        <p:column styleClass="label-field"><p:outputLabel value="#{msg['label.city']}" /></p:column>
                        <p:column>
                            <p:selectOneMenu value="#{companyController.companyModel.company.companyCity}" id="comCompanyCity">
                                <f:selectItem itemLabel="--" itemValue="" />
                                <f:selectItems value="#{companyController.prefectures}" var="prefecture" itemValue="#{prefecture.prefectureCode}" itemLabel="#{prefecture.prefectureName}"/>
                            </p:selectOneMenu>
                        </p:column>
                    </p:row>

                    <p:row>
                        <p:column styleClass="label-field"><p:outputLabel value="#{msg['label.zipcode']}" /></p:column>
                        <p:column>
                            <p:inputText value="#{companyController.companyModel.company.companyPost}" styleClass="input_post" maxlength="8">
                                <p:keyFilter regEx="/[0-9]/i" preventPaste="false"/>
                                <p:ajax event="blur" update="comCompanyCity companyAddress companyAddressKana" listener="#{companyController.onBlurCompanyPost}"/>
                                <f:validator validatorId="gnext.validator.PhoneFaxValidator" />
                                <f:attribute name="title" value="#{msg['label.zipcode']}"/>
                            </p:inputText>
                        </p:column>
                        <p:column rowspan="4" styleClass="label-field"><p:outputLabel value="#{msg['label.logo']}" /></p:column>
                        <p:column rowspan="4" >
                            <h:panelGrid columns="2">
                                <p:fileUpload label="#{msg['label.btn.upload']}" fileUploadListener="#{companyController.handleFileUpload}"
                                              id="file_drop" oncomplete="chose_file(); finish();"
                                              mode="advanced" auto="true" dragDropSupport="false"
                                              multiple="false" sizeLimit="#{layout.sizeLimitUpload}"
                                              allowTypes="#{layout.allowTypetUpload}" 
                                              onstart="start()"
                                              update="@this, companyLogoStream, :growl"
                                              styleClass="#{companyController.fileUploader.isHasImage() ? 'file_drop_no_back' : 'file_drop'}"
                                              accept="image/*">
                                    <small>#{msg['label.drop.in.here']}</small>
                                    <p:outputPanel id="companyLogoStream" class="logo_stream">
                                        <p:graphicImage value="#{companyController.fileUploader.streamedContent}" cache="false"
                                                        style="width: 50px; height: 50px;" rendered="#{companyController.fileUploader.hasImage}"
                                                        />
                                    </p:outputPanel>
                                </p:fileUpload>
                            </h:panelGrid>
                        </p:column>
                    </p:row>

                    <p:row>
                        <p:column styleClass="label-field"><p:outputLabel value="#{msg['label.address']}" /></p:column>
                        <p:column >
                            <p:inputText value="#{companyController.companyModel.company.companyAddress}" id="companyAddress" styleClass="input_text" maxlength="150" style="width: 70% !important">
                                <f:validator validatorId="gnext.validator.LengthValidator" />
                                <f:attribute name="max" value="150"/>
                                <f:attribute name="title" value="#{msg['label.address']}"/>
                            </p:inputText>
                        </p:column>
                    </p:row>

                    <p:row>
                        <p:column styleClass="label-field"><p:outputLabel value="#{msg['label.address.kana']}" /></p:column>
                        <p:column >
                            <p:inputText value="#{companyController.companyModel.company.companyAddressKana}" id="companyAddressKana" styleClass="input_text" maxlength="200" style="width: 70% !important">
                                <f:validator validatorId="gnext.validator.LengthValidator" />
                                <f:attribute name="max" value="200"/>
                                <f:attribute name="title" value="#{msg['label.address.kana']}"/>
                            </p:inputText>
                        </p:column>
                    </p:row>

                    <p:row>
                        <p:column styleClass="label-field"><p:outputLabel value="#{msg['label.copyright']}"/></p:column>
                        <p:column >
                            <p:inputText value="#{companyController.companyModel.company.companyCopyRight}" styleClass="input_text" maxlength="150">
                                <f:validator validatorId="gnext.validator.LengthValidator" />
                                <f:attribute name="max" value="150"/>
                                <f:attribute name="title" value="#{msg['label.copyright']}"/>
                            </p:inputText>
                        </p:column>
                    </p:row>

                    <p:row>
                        <p:column colspan="2" style="vertical-align: top;">
                            <p:dataList value="#{companyController.companyModel.companyPhones}" var="phone" type="definition"
                                        rowIndexVar="rowIndex"  varStatus="status" id="dataListPhone" class="crmcloud-datalist">
                                <p:panelGrid styleClass="panel-grid" id="panelGridPhone">
                                    <p:row>
                                        <p:column styleClass="label-field">
                                            <p:outputLabel value="#{msg['label.phone']}" rendered="#{(companyController.companyModel.companyPhones.size()==1)}"/>
                                            <p:outputLabel value="#{msg['label.phone']}#{rowIndex+1}" rendered="#{(companyController.companyModel.companyPhones.size()>1)}"/>
                                        </p:column>
                                        <p:column style="float:left;">
                                            <p:inputText value="#{phone.companyTargetData}" id="phone" styleClass="input_tel" maxlength="15">
                                                <p:keyFilter regEx="/[0-9\-\+]/i" preventPaste="false"/>
                                                <f:validator validatorId="gnext.validator.PhoneFaxValidator" />
                                                <f:attribute name="title" value="#{msg['label.phone']}#{rowIndex+1}"/>
                                            </p:inputText>
                                            <p:commandLink actionListener="#{companyController.removeInfos(phone)}"
                                                           style="margin-top: -4px; margin-left: 2px;" styleClass="btn btn-xs btn-default"
                                                           rendered="#{rowIndex gt 0}"
                                                           process="dataListPhone" update="dataListPhone :growl">
                                                <f:param name="type" value="phone"/>
                                                <span class="fa fa-minus-circle"></span>
                                            </p:commandLink>
                                            <p:commandLink actionListener="#{companyController.addInfo}"
                                                           style="margin-top: -4px; margin-left: 2px;" styleClass="btn btn-xs btn-default"
                                                           rendered="#{rowIndex eq 0}"
                                                           disabled="#{companyController.companyModel.companyPhones.size() gt 4}"
                                                           process="dataListPhone" update="dataListPhone :growl">
                                                <f:param name="type" value="phone"/>
                                                <span class="fa fa-plus-circle"></span>
                                            </p:commandLink>
                                        </p:column>
                                    </p:row>
                                </p:panelGrid>
                            </p:dataList>
                        </p:column>
                        <p:column colspan="2" style="vertical-align: top" rowspan="3">
                            <p:dataList value="#{companyController.companyModel.companyFaxs}" var="fax" type="definition"
                                        rowIndexVar="rowIndex"  varStatus="status" id="dataListFax" class="crmcloud-datalist">
                                <p:panelGrid styleClass="panel-grid" id="panelGridFax">
                                    <p:row>
                                        <p:column styleClass="label-field">
                                            <p:outputLabel value="#{msg['label.fax']}" rendered="#{(companyController.companyModel.companyFaxs.size()==1)}"/>
                                            <p:outputLabel value="#{msg['label.fax']}#{rowIndex+1}" rendered="#{(companyController.companyModel.companyFaxs.size()>1)}"/>
                                        </p:column>
                                        <p:column>
                                            <p:inputText value="#{fax.companyTargetData}" id="fax" styleClass="input_tel" maxlength="15">
                                                <p:keyFilter regEx="/[0-9\-\+]/i" preventPaste="false"/>
                                                <f:validator validatorId="gnext.validator.PhoneFaxValidator" />
                                                <f:attribute name="title" value="#{msg['label.fax']}#{rowIndex+1}"/>
                                            </p:inputText>
                                            <p:commandLink actionListener="#{companyController.removeInfos(fax)}"
                                                           style="margin-top: -4px; margin-left: 2px;" styleClass="btn btn-xs btn-default"
                                                           rendered="#{rowIndex gt 0}"
                                                           process="dataListFax" update="dataListFax :growl">
                                                <f:param name="type" value="fax"/>
                                                <span class="fa fa-minus-circle"></span>
                                            </p:commandLink>
                                            <p:commandLink actionListener="#{companyController.addInfo}"
                                                           style="margin-top: -4px; margin-left: 2px;" styleClass="btn btn-xs btn-default"
                                                           rendered="#{rowIndex eq 0}"
                                                           disabled="#{companyController.companyModel.companyFaxs.size() gt 4}"
                                                           process="dataListFax" update="dataListFax :growl">
                                                <f:param name="type" value="fax"/>
                                                <span class="fa fa-plus-circle"></span>
                                            </p:commandLink>
                                        </p:column>
                                    </p:row>
                                </p:panelGrid>
                            </p:dataList>
                        </p:column> 
                    </p:row>

                    <p:row>
                        <p:column colspan="2">
                            <p:dataList value="#{companyController.companyModel.companyHomepages}" var="homepage" type="definition"
                                        rowIndexVar="rowIndex"  varStatus="status" id="dataListHomepage" class="crmcloud-datalist">
                                <p:panelGrid styleClass="panel-grid" id="panelGridHomepage">
                                    <p:row>
                                        <p:column styleClass="label-field">
                                            <p:outputLabel value="#{msg['label.homepage']}"/>
                                        </p:column>
                                        <p:column style="float:left;"> 
                                            <p:inputText value="#{homepage.companyTargetData}" id="homepage" styleClass="input_text_name" maxlength="150">
                                                <f:validator validatorId="gnext.validator.UrlValidator" />
                                                <f:attribute name="title" value="#{msg['label.homepage']}"/>
                                            </p:inputText>
                                        </p:column>
                                    </p:row>
                                </p:panelGrid>
                            </p:dataList>
                        </p:column>
                    </p:row>

                    <p:row>
                        <p:column colspan="4">
                            <p:dataList value="#{companyController.companyModel.companyEmails}" var="email" type="definition"
                                        rowIndexVar="rowIndex"  varStatus="status" id="dataListEmail" class="crmcloud-datalist">
                                <p:panelGrid styleClass="panel-grid" id="panelGridEmail">
                                    <p:row>
                                        <p:column styleClass="label-field">
                                            <p:outputLabel value="#{msg['label.company.email']}" rendered="#{(companyController.companyModel.companyEmails.size()==1)}"/>
                                            <p:outputLabel value="#{msg['label.company.email']}#{rowIndex+1}" rendered="#{(companyController.companyModel.companyEmails.size()>1)}"/>
                                        </p:column>
                                        <p:column style="float:left;">
                                            <p:inputText value="#{email.companyTargetData}" id="email" styleClass="input_mail" maxlength="150">
                                                <p:keyFilter regEx="/[a-z0-9_\.\-@]/i" preventPaste="false"/>
                                                <!--<f:validateRegex pattern="^[_A-Za-z0-9-\+]+(\.[_A-Za-z0-9-]+)*@[A-Za-z0-9-]+(\.[A-Za-z0-9]+)*(\.[A-Za-z]{2,})$" />-->
                                                <f:validator validatorId="gnext.validator.EmailValidator" />
                                                <f:attribute name="title" value="#{msg['label.email']}#{rowIndex+1}"/>
                                            </p:inputText>
                                            <p:commandLink actionListener="#{companyController.removeInfos(email)}"
                                                           style="margin-top: -4px; margin-left: 2px;" styleClass="btn btn-xs btn-default"
                                                           rendered="#{rowIndex gt 0}"
                                                           process="dataListEmail" update="dataListEmail :growl">
                                                <f:param name="type" value="email"/>
                                                <span class="fa fa-minus-circle"></span>
                                            </p:commandLink>
                                            <p:commandLink actionListener="#{companyController.addInfo}"
                                                           style="margin-top: -4px; margin-left: 2px;" styleClass="btn btn-xs btn-default"
                                                           rendered="#{rowIndex eq 0}"
                                                           disabled="#{companyController.companyModel.companyEmails.size() gt 4}"
                                                           process="dataListEmail" update="dataListEmail :growl">
                                                <f:param name="type" value="email"/>
                                                <span class="fa fa-plus-circle"></span>
                                            </p:commandLink>
                                        </p:column>
                                    </p:row>
                                </p:panelGrid>
                            </p:dataList>
                        </p:column>
                    </p:row>

                    <p:row>
                        <p:column styleClass="label-field" style="vertical-align: top"><p:outputLabel value="#{msg['label.layout']}"/></p:column>
                        <p:column style="vertical-align: top">
                            <p:selectOneMenu value="#{companyController.companyModel.company.companyLayout}">
                                <f:selectItem itemLabel="--" itemValue="" />
                                <f:selectItems value="#{companyController.themes}" var="themes" itemLabel="${themes.label}" itemValue="#{themes.value}"/>
                            </p:selectOneMenu>
                        </p:column>
                        <p:column colspan="2" style="vertical-align: top" rowspan="2">
                            <p:dataList value="#{companyController.companyModel.companyIps}" var="ip" type="definition" rowIndexVar="rowIndex" varStatus="status" id="dataListIp" class="crmcloud-datalist">
                                <p:panelGrid styleClass="panel-grid" id="panelGridIp">
                                    <p:row>
                                        <p:column styleClass="label-field">
                                            <p:outputLabel value="#{msg['label.ip']}" rendered="#{(companyController.companyModel.companyIps.size()==1)}"/>
                                            <p:outputLabel value="#{msg['label.ip']}#{rowIndex+1}" rendered="#{(companyController.companyModel.companyIps.size()>1)}"/>
                                        </p:column>
                                        <p:column style="text-align: left;">
                                            <p:inputMask mask="999.999.999.999" value="#{ip.companyTargetData}" id="txtIp" styleClass="input_tel">
                                                <f:validator validatorId="gnext.validator.IpValidator" />
                                                <f:attribute name="title" value="#{msg['label.ip']}#{rowIndex+1}"/>
                                            </p:inputMask>
                                            <p:commandLink actionListener="#{companyController.removeInfos(ip)}"
                                                           style="margin-top: -4px; margin-left: 2px;" styleClass="btn btn-xs btn-default"
                                                           rendered="#{rowIndex gt 0}"
                                                           process="dataListIp" update="dataListIp :growl">
                                                <f:param name="type" value="Ip"/>
                                                <span class="fa fa-minus-circle"></span>
                                            </p:commandLink>
                                            <p:commandLink actionListener="#{companyController.addInfo}" process="dataListIp" update="dataListIp :growl"
                                                           style="margin-top: -4px; margin-left: 2px;" styleClass="btn btn-xs btn-default"
                                                           rendered="#{rowIndex eq 0}"
                                                           disabled="#{companyController.companyModel.companyIps.size() gt 4}">
                                                <f:param name="type" value="Ip"/>
                                                <span class="fa fa-plus-circle"></span>
                                            </p:commandLink>
                                        </p:column>
                                    </p:row>
                                </p:panelGrid>
                            </p:dataList>
                        </p:column>
                    </p:row>

                    <p:row>
                        <p:column styleClass="label-field"><p:outputLabel value="#{companyBundle['label.company.globalgroupflag']}"/></p:column>
                        <p:column><p:selectBooleanCheckbox value="#{companyController.companyModel.companyGlobalLocale}"/></p:column>
                    </p:row>

                    <p:row>
                        <p:column styleClass="label-field"><p:outputLabel value="#{msg['label.memo']}"/></p:column>
                        <p:column colspan="3">
                            <p:inputTextarea value="#{companyController.companyModel.company.companyMemo}" styleClass="input_memo">
                                <f:validator validatorId="gnext.validator.LengthValidator" />
                                <f:attribute name="max" value="500"/>
                                <f:attribute name="title" value="#{msg['label.memo']}"/>
                            </p:inputTextarea>
                        </p:column>
                    </p:row>
                </p:panelGrid>
            </div>
        </div>
    </h:form>

<!-- LAMP色を取得 -->
<ui:include src="/modules/company/dailog/db_server.xhtml" />

<script>
    function resetUI() {
        resetPanelCompanyGroups();
    }

    $(document).ready(function () {
        resetUI();
        chose_file();
    });
    function chose_file() {
        $('#frmCompany\\:file_drop').on('click', function (e) {
            $('#frmCompany\\:file_drop_input').click();
        });
        $('#frmCompany\\:file_drop_input').click(function (e) {
            e.stopImmediatePropagation();
        });
    }
</script>
</ui:composition>
