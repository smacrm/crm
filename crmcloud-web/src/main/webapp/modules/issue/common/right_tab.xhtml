<?xml version='1.0' encoding='UTF-8' ?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:a="http://xmlns.jcp.org/jsf/passthrough"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
    <p:remoteCommand name="setCustomerClick" actionListener="#{customerController.create}">
        <f:attribute name="windowType" value="ISSUE"></f:attribute>
    </p:remoteCommand>
    <p:remoteCommand name="reloadCustomerList" actionListener="#{issueController.reloadCustomer()}"></p:remoteCommand>
    <c:set var="softphone_mode" value="#{configController.getConfig('SOFTPHONE_MODE')}" />
    <c:set var="display_max_customer" value="1" />
    <p:tabView id="tabViewCustomer" styleClass="tabViewCustomer" scrollable="false">
        
        <c:if test="#{loginController.member.companyStoreMode}">
            <ui:include src="/modules/issue/common/info_tab.xhtml"/>
        </c:if>
        
        <c:if test="#{!loginController.member.companyStoreMode}">
            <c:set var="customerList" value="#{issueController.issue.customerList}"/>
            <c:forEach var="customer" items="#{customerList}" varStatus="tabIndex" begin="0" end="#{display_max_customer}">
                <p:tab>
                    <ui:include src="/modules/issue/common/customer.xhtml" >
                        <ui:param name="customerIndex" value="#{tabIndex.index}"/>
                    </ui:include>
                </p:tab>
            </c:forEach>
        
            <p:tab rendered="#{customerList.size() gt display_max_customer + 1}" id="customerLazyList">
                <c:set var="customer" value="#{customerList.size() gt display_max_customer + 1 ? customerList.get( issueController.customerViewIndex eq 0 ? display_max_customer + 1 : issueController.customerViewIndex) : null}"/>
                <f:facet name="title">
                    <p:selectOneMenu  style="border: 0; margin-top: 0.2em" value="#{issueController.customerViewIndex}">
                        <p:ajax update="customerLazyPanel" onstart="start()" onsuccess="finish()"/>
                        <c:forEach items="#{customerList}" varStatus="loop" begin="#{display_max_customer + 1}">
                            <f:selectItem itemLabel="(#{loop.index})" itemValue="#{loop.index}"/>
                        </c:forEach>
                    </p:selectOneMenu>
                    <p:commandLink
                        onstart="start()" onsuccess="finish()"
                        actionListener="#{issueController.removeCustomer(customer.tabIdx)}" update="tabViewCustomer, :growl"
                        process="@this"
                        rendered="#{sec.isMaster() or sec.hasMethod('CustomerController', 'DELETE')}"
                        style="padding: .7em; cursor: pointer"
                        styleClass="fa fa-times">
                        <p:confirm
                            header="${msg['label.delete']}"
                            message="${issue['label.delete_customer']}"
                            icon="ui-icon-alert" />
                    </p:commandLink>
                </f:facet>
                <p:outputPanel id="customerLazyPanel" rendered="#{customerList.size() gt display_max_customer}">
                    <ui:include src="/modules/issue/common/customer.xhtml">
                        <ui:param name="renderTitle" value="false"/>
                        <ui:param name="customerIndex" value="#{customerList.size()}"/>
                    </ui:include>
                </p:outputPanel>
            </p:tab>

            <p:tab id="tabCustomerHistory" rendered="#{sec.isMaster() or sec.hasMethod('CustomerController', 'CUSTOMER_HISTORY')}">
                <f:facet name="title">
                    ${issue['label.tab_customer_history']} 
                    <h:outputText
                        id="tabCustomerHistoryTitle"
                        value="(${issueController.issue.historyCustomers.size()}${issue['label.count']})" />
                </f:facet>
                <ui:include src="customer_history.xhtml" />
            </p:tab>

            <p:tab id="tabCustomerSpecial" rendered="#{sec.isMaster() or sec.hasMethod('CustomerController', 'CUSTOMER_SPECIAL')}">
                <f:facet name="title">
                    ${issue['label.tab_customer_special']} 
                    <h:outputText
                        id="tabCustomerSpecialTitle"
                        value="(${issueController.issue.historySpecials.size()}${issue['label.count']})" />
                    <p:commandLink
                        id="issueCustomerSpecial"
                        rendered="#{sec.isMaster() or sec.hasMethod('CustomerController', 'CREATE')}"
                        actionListener="${dialogController.openCustDialog(0, false)}"
                        onclick="setCustomerClick([{name: 'custId', value: 0}]);"
                        onstart="start()" onsuccess="finish()"
                        process="@this"
                        oncomplete="setTimeout(function () {CRMCLOUD.dialogFrameWorkTop('form_issue', 'issueCustomerSpecial');}, 50);"
                        styleClass="btn btn-xs btn-default fa fa-plus-circle link-add-icon" >
                        <f:param name="width" value="800" />
                        <f:attribute name="windowType" value="ISSUE"></f:attribute>
                        <f:param name="custId" value="0" /> <!-- truong hop them moi khach hang dac biet(custId=0) -->
                        <p:ajax
                            event="dialogReturn"
                            oncomplete="activeCurentTap($.trim($('#issueActiveTab').val()), 'tabViewIssue');"
                            update="@this:tabViewCustomer:panelGrid_customerSpecials, @this:tabCustomerSpecialTitle, :growl" />
                    </p:commandLink>
                </f:facet>
                <ui:include src="customer_special.xhtml" />
            </p:tab>
        </c:if>
    </p:tabView>
    <h:outputStylesheet>
        a[href='#tabViewCustomer:customerLazyList'] {
            padding: 0 0.5em 0 1em !important;
        }
    </h:outputStylesheet>
</ui:composition>
