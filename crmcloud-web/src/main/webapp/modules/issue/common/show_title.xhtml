<?xml version='1.0' encoding='UTF-8' ?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">

    <c:set var="issueEditing" value="#{issueGlobalStatus.isEditing(issueController.companyId, issueController.issue.issueId) and !issueGlobalStatus.isEditingByMember(issueController.companyId, issueController.issue.issueId, loginController.member.userId)}"/>
    <h:panelGrid width="100%" styleClass="page-header">
        <f:facet name="header">
            <div class="row">
                <div class="col-md-4">
                    <h1>
                        ${issue['label.page.issue']}
                        <small style="display: inline-flex;background: transparent;">
                            <p:outputLabel value="${msg['label.show']}" style="margin-right: 0.5em !important;" />
                            <h:outputLabel
                                styleClass="outputLabelLamp"
                                style="background: ##{issueController.issue.lampColor};color: ##{issueController.issue.lampTextColor}"
                                value="#{issueLampController.getLampNameByColor(issueController.issue.lampColor)}"
                                rendered="#{!empty issueController.issue.lampColor}"/>
                        </small>
                    </h1>
                </div>
                <div class="col-md-8 text-right">
                    <p:commandButton
                        value="${msg['label.create']}"
                        process="@this"
                        rendered="#{(sec.isMaster() or sec.hasMethod('IssueController', 'create'))}"
                        actionListener="#{issueController.create}"
                        icon="fa fa-plus-circle"  
                        update="mainContent" onclick="this.form.action = '/index.xhtml?id=0';"
                        onstart="start()" onsuccess="finish()">
                        <f:param name="id" value="0"/>
                        <f:param name="issueIdx" value="notNext" />
                        <f:param name="force" value="true"/>
                    </p:commandButton>

                    <p:splitButton
                        value="${issue['label.customer_correspondence_input']}"
                        icon="fa fa-pencil"
                        styleClass="splitButton_not_value">
                        <p:menuitem rendered="#{(sec.isMaster() or sec.hasMethod('IssueCustSupportController', 'create'))}">
                            <p:commandLink
                                actionListener="#{issueCustSupportController.create()}"
                                update=":panelCustomerSupportMail"
                                oncomplete="PF('dlgCustomerSupportMail').show();"
                                process="@this"
                                styleClass="navBarMenuitemCommandLink"
                                onstart="start()" onsuccess="finish()">
                                <i class="fa fa-user-md"></i>
                                <h:outputLabel value="${issue['label.escalation_4']}" />
                            </p:commandLink>
                        </p:menuitem>
                        <p:menuitem rendered="#{(sec.isMaster() or sec.hasMethod('IssueCustSupportController', 'create'))}">
                            <p:commandLink
                                actionListener="#{issueSupportController.create('1')}"
                                oncomplete="PF('dlgSendSupportMail').show();"
                                update=":panelGridDialogMailSupport"
                                process="@this"
                                styleClass="navBarMenuitemCommandLink"
                                onstart="start()" onsuccess="finish()">
                                <i class="fa fa-paper-plane-o"></i>
                                <h:outputLabel value="${issue['label.mail_correspondence_customers']}" />
                                <f:param name="issueId" value="${issueController.issue.issueId}" />
                            </p:commandLink>
                        </p:menuitem>
                        <p:menuitem rendered="#{(sec.isMaster() or sec.hasMethod('IssueCommentController', 'create'))}">
                            <p:commandLink
                                actionListener="#{issueCommentController.create()}"
                                update=":panelSendComment"
                                oncomplete="PF('dlgCommentMail').show();"
                                process="@this"
                                styleClass="navBarMenuitemCommandLink"
                                onstart="start()" onsuccess="finish()">
                                <i class="fa fa-pencil"></i>
                                <h:outputLabel value="${issue['label.escalation_3']}" />
                            </p:commandLink>
                        </p:menuitem>
                    </p:splitButton>

                    <p:commandButton
                        rendered="#{(sec.isMaster() or sec.hasMethod('IssueSupportController', 'REQUESTMAIL'))}"
                        actionListener="#{issueSupportController.create('2')}"
                        update=":inputTextRequestMailSubject, :inputTextareaRequestMailBody, :inputTextareaRequestMailFooter, :panel_to_d_o_users, :panel_cc_d_o_users, :panel_bcc_d_o_users"
                        oncomplete="PF('dlgSendRequestMail').show();"
                        value="${issue['label.escalation_2']}"
                        icon="fa fa-mail-reply"
                        process="@this"
                        onstart="start()" onsuccess="finish()">
                        <f:param name="issueId" value="${issueController.issue.issueId}" />
                    </p:commandButton>
                    <p:commandButton
                        rendered="#{(sec.isMaster() or sec.hasMethod('IssueController', 'create'))}"
                        value="${msg['label.replication']}"
                        actionListener="${issueController.duplicate(issueController.issue)}"
                        action="#{issueController.outcome(-1)}"
                        onclick="this.form.target = '_blank';"
                        ajax="false"
                        disabled="#{issueEditing}"
                        process="@this"
                        icon="fa fa-copy"
                        onblur="this.form.target = '_self';">
                        <f:param name="id" value="-1"/>
                        <f:param name="force" value="true"/>
                    </p:commandButton>

                    <p:commandButton
                        rendered="#{(sec.isMaster() or sec.hasMethod('IssueController', 'update'))}"
                        value="${msg['label.edit']}"
                        actionListener="#{issueController.edit()}"
                        process="@this"
                        icon="fa fa-pencil"  
                        disabled="#{issueEditing}"
                        update="mainContent ,:growl"
                        onstart="start()" onsuccess="finish()">
                        <f:param name="id" value="${issueController.issue.issueId}" />
                        <f:param name="issueIdx" value="#{issueController.issueIdx}" />
                        <f:param name="force" value="true"/>
                    </p:commandButton>
                    <p:commandButton
                        value="${msg['label.delete']}"
                        rendered="#{(sec.isMaster() or sec.hasMethod('IssueController', 'delete'))}"
                        actionListener="#{issueController.delete}"
                        process="@this"
                        icon="fa fa-trash-o"  
                        disabled="#{issueEditing}"
                        update="mainContent :growl"
                        onstart="start()" onsuccess="finish()">
                        <f:param name="id" value="${issueController.issue.issueId}" />
                        <f:param name="issueIdx" value="#{issueController.issueIdx}" />
                        <p:confirm header="#{msg['label.confirm']}" message="#{issue['label.delete_issue']}" icon="ui-icon-alert"/>
                        <f:param name="force" value="true"/>
                    </p:commandButton>
                    <p:commandButton
                        rendered="#{(sec.isMaster() or sec.hasMethod('IssueController', 'print'))}"
                        value="#{msg['label.print']}"
                        type="button"
                        icon="ui-icon-print">
                        <p:printer target="issuePrintBlock" />
                    </p:commandButton>
                    <c:if test="${!empty issueController.issueIdx and  !empty issueController.ais.issues and param['redirect'] ne 'true'}">
                        <p:panel id="panelSizeCount" styleClass="ui-buttonset ui-widget divPanelSizeCount" rendered="#{sec.hasMethod('IssueController', 'view')}">
                            <c:if test="${!empty issueController.issueIdx and issueController.issueIdx > 0}">
                                <p:commandButton
                                    action="#{issueController.skip('show')}"
                                    oncomplete="reRenderDynamicForm();"
                                    process="@this"
                                    title="#{msg['label.previous']}"
                                    icon="fa fa-angle-left"
                                    styleClass="ui-corner-left"
                                    onstart="start()" onsuccess="finish()"
                                    update="issuePrintBlock, @this:panelSizeCount ,:growl">
                                    <f:param name="force" value="true"/>
                                    <f:param name="issueIdx" value="#{issueController.issueIdx - 1}"/>
                                </p:commandButton>
                            </c:if>
                            <p:commandButton
                                value="${issueController.issueIdx+1}/${issueController.ais.issues.size()}"
                                styleClass="ui-corner-none"/>
                            <c:if test="${!empty issueController.issueIdx and issueController.issueIdx ne issueController.ais.issues.size()-1}">
                                <p:commandButton
                                    action="#{issueController.skip('show')}"
                                    oncomplete="reRenderDynamicForm();"
                                    process="@this"
                                    title="#{msg['label.next']}"
                                    icon="fa fa-angle-right"
                                    styleClass="ui-corner-right"
                                    onstart="start()" onsuccess="finish()"
                                    update="issuePrintBlock, @this:panelSizeCount ,:growl">
                                    <f:param name="force" value="true"/>
                                    <f:param name="issueIdx" value="#{issueController.issueIdx + 1}"/>
                                </p:commandButton>
                            </c:if>
                        </p:panel>
                    </c:if>

                </div>
            </div>
            <p:outputPanel styleClass="row" rendered="#{issueEditing}">
                <c:set var="profile" value="#{issueGlobalStatus.getEditingProfile(issueController.companyId, issueController.issue.issueId)}"/>
                <div class="col-sm-12">
                    <div class="alert alert-warning alert-dismissible">
                        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">#{issue['label.btn.close']}</button>
                        <i class="icon fa fa-warning"></i>
                        <h:outputFormat value="#{issue['label.issue.editing.warning']}">
                            <f:param value="#{profile.memberFullName}" />
                        </h:outputFormat>
                    </div>
                </div>
            </p:outputPanel>
        </f:facet>
    </h:panelGrid>
</ui:composition>
