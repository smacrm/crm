<?xml version='1.0' encoding='UTF-8' ?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
    <c:set var="softphone_mode" value="#{configController.getConfig('SOFTPHONE_MODE')}" />
    <c:set var="display_max_customer" value="1" />
    
    <p:tabView id="tabViewCustomer" styleClass="tabViewCustomer panelGridShow" scrollable="false">
         <c:if test="#{loginController.member.companyStoreMode}">
            <ui:include src="/modules/issue/common/show_info_tab.xhtml"/>
        </c:if>
        <c:if test="#{!loginController.member.companyStoreMode}">
            <c:set var="customerList" value="#{issueController.issue.customerList}"/>
            <c:forEach var="customer" items="#{customerList}" varStatus="tabIndex" begin="0" end="#{display_max_customer}">
                <p:tab id="cust_#{customer.tabIdx}">
                    <ui:include src="/modules/issue/common/show_customer.xhtml" />
                </p:tab>
            </c:forEach>
            <p:tab rendered="#{customerList.size() gt display_max_customer + 1}" id="customerLazyList">
                <f:facet name="title">
                    <p:selectOneMenu  style="border: 0; margin-top: 0.2em" value="#{issueController.customerViewIndex}">
                        <p:ajax update="customerLazyPanel" onstart="start()" onsuccess="finish()"/>
                        <c:forEach items="#{customerList}" varStatus="loop" begin="#{display_max_customer + 1}">
                            <f:selectItem itemLabel="(#{loop.index})" itemValue="#{loop.index}"/>
                        </c:forEach>
                    </p:selectOneMenu>
                </f:facet>
                <p:outputPanel id="customerLazyPanel" rendered="#{customerList.size() gt display_max_customer}">
                    <ui:include src="/modules/issue/common/show_customer.xhtml">
                        <ui:param name="customer" value="#{customerList.size() gt display_max_customer + 1 ? customerList.get( issueController.customerViewIndex eq 0 ? display_max_customer + 1 : issueController.customerViewIndex) : null}"/>
                        <ui:param name="renderTitle" value="false"/>
                    </ui:include>
                </p:outputPanel>
            </p:tab>
            <p:tab id="tabCustomerHistory" rendered="#{sec.isMaster() or sec.hasMethod('CustomerController', 'CUSTOMER_HISTORY')}">
                <f:facet name="title">
                    ${issue['label.tab_customer_history']} 
                    <h:outputText
                        id="tabCustomerHistoryTitle"
                        value="(${issueController.issue.historyCustomers.size()}${issue['label.count']})" />
                </f:facet>
                <ui:include src="customer_history.xhtml" >
                    <ui:param name="renderButton" value="no"/>
                </ui:include>
            </p:tab>
            <p:tab id="tabCustomerSpecial" rendered="#{sec.isMaster() or sec.hasMethod('CustomerController', 'CUSTOMER_SPECIAL')}">
                <f:facet name="title">
                    ${issue['label.tab_customer_special']} 
                    <h:outputText
                        id="tabCustomerSpecialTitle"
                        value="(${issueController.issue.historySpecials.size()}${issue['label.count']})" />
                </f:facet>
                <ui:include src="customer_special.xhtml" >
                    <ui:param name="renderButton" value="no"/>
                </ui:include>
            </p:tab>
        </c:if>
    </p:tabView>
    <h:outputStylesheet>
        a[href='#tabViewCustomer:customerLazyList'] {
            padding: 0 0.5em 0 1em !important;
        }
    </h:outputStylesheet>
</ui:composition>
