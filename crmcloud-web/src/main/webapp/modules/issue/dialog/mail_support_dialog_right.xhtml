<?xml version='1.0' encoding='UTF-8' ?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">

<p:panelGrid id="panelSendSupportMail" styleClass="panelGridDialogMailSupport">
    <p:row>
        <p:column colspan="4" styleClass="td_center td_padding">
            <p:panel id="panelTopButton">
                <p:commandButton
                    onstart="start()" onsuccess="finish()"
                    actionListener="${issueSupportController.save}"
                    icon="fa fa-save"
                    value="${msg['label.save']}"
                    update=":panelTopButton, :panelSendSupportMail :growl"
                    process="@this:panelSendSupportMail">
                    <f:param name="issueId" value="${issueController.issue.issueId}" />
                </p:commandButton>
                <p:commandButton
                    id="commandButtonSend"
                    onstart="start()" onsuccess="finish()"
                    actionListener="${issueSupportController.sendSupport()}"
                    oncomplete="handleCloseDialog(xhr, status, args, 'dlgSendSupportMail')"
                    icon="fa fa-send-o"
                    value="${msg['label.send']}"
                    update="@(.toggleablePanelEscalation), :growl"
                    process="@this:panelSendSupportMail"
                    disabled="${empty issueSupportController.mailApprovalUserId || empty issueSupportController.tos || empty issueSupportController.supportMail.sendMail.subject || empty issueSupportController.supportMail.sendMail.message}" >
                    <f:param name="issueId" value="${issueController.issue.issueId}" />
                </p:commandButton>
                <p:commandButton
                    onstart="start()" onsuccess="finish()"
                    actionListener="${issueSupportController.delete}"
                    icon="fa fa-trash-o"
                    value="${msg['label.delete']}"
                    update=":panelTopButton, :panelChildMailRequestUserName, :panelMailApprovalName, :inputTextSupportMailSubject, :inputTextareaSupportMailBody, :inputTextareaSupportMailFooter, :panelDataTableEmailFileList, :growl"
                    process="@this"
                    disabled="${empty issueSupportController.escalation.escalationId}">
                    <f:param name="issueId" value="${issueController.issue.issueId}" />
                </p:commandButton>
                <p:commandButton
                    value="#{msg['label.print']}"
                    icon="fa fa-print"
                    type="button"
                    rendered="#{sec.hasMethod('IssueSupportController', 'print')}">
                    <p:printer target="@this:panelSendSupportMail"/>
                </p:commandButton>
            </p:panel>
        </p:column>
    </p:row>

    <p:row>
        <p:column style="width: 80px">
            <p:commandButton
                onclick="PF('dlgSendRequestMail').show(); allowExecuteCallbackDialog = false;"
                rendered="#{(sec.isMaster() or sec.hasMethod('IssueSupportController', 'create'))}"
                process="@this"
                value="${msg['label.claim']}">
                <p:ajax listener="#{issueSupportController.onMailRequest(true)}" update=":inputTextRequestMailSubject, :inputTextareaRequestMailBody, :inputTextareaRequestMailFooter, :panel_to_d_o_users, :panel_cc_d_o_users, :panel_bcc_d_o_users" />
                <f:param name="issueId" value="${issueController.issue.issueId}" />
            </p:commandButton>
        </p:column>
        <p:column styleClass="td_35">
            <p:panel id="panelChildMailRequestUserName" styleClass="panelChildMailRequestUserName">
                <h:outputLabel value="#{issueSupportController.mailRequestUserName}" />
                <br />
                <h:outputLabel value="${issueSupportController.mailRequestDate}" >
                    <f:convertDateTime type="date" pattern="yyyy/MM/dd HH:mm"/>
                </h:outputLabel>
            </p:panel>
        </p:column>
        <p:column styleClass="td_not_padding td_15">
            <p:commandButton
                id="commandLinkMailApprovalUserName"
                actionListener="#{issueSupportController.getLoginUserName}"
                value="${msg['label.approval']}"
                process="@this"
                update="@this:panelMailApprovalName, @this:commandButtonSend"
                disabled="${empty issueSupportController.supportMail.sendMail.subject || empty issueSupportController.supportMail.sendMail.message}" />
        </p:column>
        <p:column style="vertical-align: middle;">
            <p:panel id="panelMailApprovalName" styleClass="panelMarginPaddingBorder_none">
                <h:outputLabel value="#{issueSupportController.mailApprovalUserName}" />
                <p:commandLink
                    onstart="start()" onsuccess="finish()"
                    actionListener="#{issueSupportController.deleteLoginUserName}"
                    update="@this:panelMailApprovalName, @this:commandButtonSend"
                    process="@this"
                    rendered="${!empty issueSupportController.mailApprovalUserName}"
                    styleClass="btn btn-xs btn-default"
                    style="float: right;">
                        <span class="fa fa-minus-circle"></span>
                </p:commandLink>
            </p:panel>
        </p:column>
    </p:row>
    <p:row>
        <p:column>
            <h:outputLabel value="#{msg['label.mail.from']}" />
            <font>*</font>
        </p:column>
        <p:column>
            <p:selectOneMenu value="#{issueSupportController.supportMail.sendMail.from}" >
                <f:selectItems
                    var="froms"
                    value="${issueSupportController.froms}"
                    itemLabel="${froms.accountMailAddress}"
                    itemValue="${froms.accountMailAddress}"/>
            </p:selectOneMenu>
        </p:column>
        <p:column>
            <h:outputLabel value="#{msg['label.mail.to']}" />
            <font>*</font>
        </p:column>
        <p:column>
            <p:selectOneMenu value="#{issueSupportController.supportMail.to}" >
                <f:selectItems
                    var="to"
                    value="${issueSupportController.tos}"
                    itemLabel="${to.custTargetData}"
                    itemValue="${to.custTargetData}"/>
            </p:selectOneMenu>
        </p:column>
    </p:row>
    <p:row>
        <p:column>
            <h:outputLabel value="#{msg['label.mail.subject']}" />
            <font>*</font>
        </p:column>
        <p:column colspan="3">
            <p:inputText
                id="inputTextSupportMailSubject"
                value="#{issueSupportController.supportMail.sendMail.subject}"
                style="width: 100% !important;">
                <f:validator validatorId="gnext.validator.LengthValidator" />
                <f:attribute name="max" value="100"/>
                <f:attribute name="title" value="#{msg['label.mail.subject']}"/>
                <p:ajax event="keyup" update="@this:commandLinkMailApprovalUserName, @this:commandButtonSend" />
            </p:inputText>
        </p:column>
    </p:row>
    <p:row>
        <p:column>
            <h:outputLabel value="#{mailBundle['label.mail.header']}" />
        </p:column>
        <p:column colspan="3" styleClass="td_not_padding">
            <p:inputTextarea
                id="inputTextSupportMailHeader"
                rows="2"
                autoResize="false"
                value="#{issueSupportController.supportMail.header}" >
                <f:validator validatorId="gnext.validator.LengthValidator" />
                <f:attribute name="max" value="300"/>
                <f:attribute name="title" value="#{mailBundle['label.mail.header']}"/>
            </p:inputTextarea>
        </p:column>
    </p:row>
    <p:row>
        <p:column>
            <h:outputLabel value="#{msg['label.mail.comment']}" />
            <font>*</font>
        </p:column>
        <p:column colspan="3" styleClass="td_not_padding">
            <p:inputTextarea
                id="inputTextareaSupportMailBody"
                rows="10"
                autoResize="false"
                value="#{issueSupportController.supportMail.sendMail.message}"
                styleClass="inputTextareaSendMailComment">
<!--                <f:validator validatorId="gnext.validator.RequiredValidator" />
                <f:validator validatorId="gnext.validator.LengthValidator" />
                <f:attribute name="max" value="20000"/>
                <f:attribute name="title" value="#{msg['label.mail.comment']}"/>-->
                <p:ajax event="keyup" update="@this:commandLinkMailApprovalUserName, @this:commandButtonSend" />
            </p:inputTextarea>
        </p:column>
    </p:row>
    <p:row>
        <p:column>
            <h:outputLabel value="#{mailBundle['label.mail.footer']}" />
        </p:column>
        <p:column colspan="3" styleClass="td_not_padding">
            <p:inputTextarea
                id="inputTextareaSupportMailFooter"
                rows="3"
                autoResize="false"
                value="#{issueSupportController.supportMail.footer}">
                <f:validator validatorId="gnext.validator.LengthValidator" />
                <f:attribute name="max" value="500"/>
                <f:attribute name="title" value="#{mailBundle['label.mail.footer']}"/>
            </p:inputTextarea>
        </p:column>
    </p:row>
    <p:row rendered="#{sec.isMaster() or sec.hasMethod('IssueSupportController', 'upload')}">
        <p:column colspan="4" styleClass="verticalAlignTop">
            <div class="flex flex_row">
                <div class="flex_1" style="width: 130px">
                    <p:fileUpload
                        onstart="start()" oncomplete="finish()"
                        auto="true"
                        label="#{msg['label.add.file']}"
                        fileUploadListener="#{issueSupportController.upload}"
                        id="fileUploadSuportRigth"
                        process="@this"
                        mode="advanced"
                        dragDropSupport="true"
                        update="panelDataTableEmailFileList, :growl"
                        sizeLimit="1000000"
                        allowTypes="/(\.|\/)(gif|jpe?g|png|zip|csv|xls|xlsx|pdf)$/"
                        styleClass="fileUploadContentBackground">
                        <small>#{msg['label.drop.in.here']}</small>
                    </p:fileUpload>
                </div>
                <div class="flex_1_1" style="overflow: auto; height: 140px;">
                    <p:panel id="panelDataTableEmailFileList" styleClass="panelDataTableEmailFileList">
                        <table class="table table-responsive table-bordered table-hover" id="table-attachments">
                            <thead>
                                <tr>
                                    <td>#</td>
                                    <td>#{msg['label.file.name']}</td>
                                    <td>#{msg['label.size']}</td>
                                </tr>
                            </thead>
                            <tbody>
                                <ui:repeat value="#{issueSupportController.supportMail.attachs}" var="file" varStatus="supportIdx">
                                <tr>
                                    <td>
                                        <p:commandLink
                                            onstart="start()" onsuccess="finish()"
                                            actionListener="#{issueSupportController.deleteFile}"
                                            update="panelDataTableEmailFileList"
                                            process="@this"
                                            disabled="#{!(sec.isMaster() or sec.hasMethod('IssueSupportController', 'DELETEFILE'))}"
                                            styleClass="btn btn-xs btn-default">
                                                <f:param name="idx" value="#{supportIdx.index}" />
                                                <span class="fa fa-minus-circle"></span>
                                        </p:commandLink>
                                    </td>
                                    <td><h:outputLabel value="#{file.file.fileName}" /></td>
                                    <td><h:outputLabel value="#{file.sizeView}" /></td>
                                </tr>
                                </ui:repeat>
                            </tbody>
                        </table>
                    </p:panel>
                </div>
            </div>
            
        </p:column>
    </p:row>
</p:panelGrid>
</ui:composition>