<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:p="http://primefaces.org/ui"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
<h:body>
<h:form id="chat_form">
    <p:menuButton>
        <p:menuitem value="Save"  icon="ui-icon-disk"/>
        <p:menuitem value="Update"  icon="ui-icon-arrowrefresh-1-w"/>
        <p:menuitem value="Delete"   icon="ui-icon-close"/>
    </p:menuButton>
    <p:menuButton id="bt_groups" style="float: right" rendered="#{chatUsers.uL != null}">
                <p:dataList id="groups" var="g" value="#{chatUsers.uL}">
                    <p:commandButton title="Chat" icon="ui-icon-comment" oncomplete="PF('pChat').show()" update=":chat_form:privateChatContainer">
                        <f:setPropertyActionListener value="#{g.groupId}" target="#{g.groupName}" />
                    </p:commandButton>
                </p:dataList>
    </p:menuButton>

    
<br/>
<br/>
<br/>
<p:remoteCommand name="updateList" update="users" process="@this" />

    <p:fieldset id="container" legend="PrimeChat" toggleable="true">

        <h:panelGroup rendered="#{chatView.loggedIn}">
            <h:panelGrid columns="2" columnClasses="publicColumn,usersColumn" style="width:100%">
                <p:outputPanel id="public" layout="block" styleClass="ui-corner-all ui-widget-content chatlogs" />

                <p:dataList id="users" var="user" value="#{chatUsers.uL}" styleClass="usersList">
                    <f:facet name="header">
                        Users
                    </f:facet>

                    <p:commandButton title="Chat" icon="ui-icon-comment" oncomplete="PF('pChat').show()" update=":chat_form:privateChatContainer">
                        <f:setPropertyActionListener value="#{users.groupId}" target="#{users.groupName}" />
                    </p:commandButton>
                    #{user}
                </p:dataList>
            </h:panelGrid>

            <p:separator />

            <p:inputText value="#{chatView.globalMessage}" styleClass="messageInput" />
            <p:spacer width="5" />
            <p:commandButton value="Send" actionListener="#{chatView.sendGlobal}" oncomplete="$('.messageInput').val('').focus()" />
            <p:spacer width="5" />
            <p:commandButton value="Disconnect" actionListener="#{chatView.disconnect}" global="false" update="container" />
        </h:panelGroup>

        <h:panelGroup rendered="#{not chatView.loggedIn}" >
            Username: <p:inputText value="#{chatView.username}" />

            <p:spacer width="5" />
            <p:commandButton value="Login" actionListener="#{chatView.login}" update="container" 
                             icon="ui-icon-person" />
        </h:panelGroup>

    </p:fieldset>

    <p:dialog widgetVar="pChat" header="Private Chat" modal="true" showEffect="fade" hideEffect="fade">
        <h:panelGrid id="privateChatContainer" columns="2" columnClasses="vtop,vtop">
            <p:outputLabel for="pChatInput" value="To: #{chatView.privateUser}" />
            <p:inputTextarea id="pChatInput" value="#{chatView.privateMessage}" rows="5" cols="30" />

            <p:spacer />
            <p:commandButton value="Send" actionListener="#{chatView.sendPrivate}" oncomplete="PF('pChat').hide()" />
        </h:panelGrid>
    </p:dialog>

<p:socket onMessage="handleMessage" channel="/{#{login.userDto.groupId}}" autoConnect="false" widgetVar='subscriber' />
</h:form>


<script type="text/javascript">
function handleMessage(message) {
    PF('widget_growl').renderMessage({"summary":message.user,"detail":message.text,"severity":"info"});

    var chatContent = $(PrimeFaces.escapeClientId('chat_form:public')),
    text = (message.user) ? message.user + ':' + message.text: message.text;
    chatContent.append(text + '<br />');
    //keep scroll
    chatContent.scrollTop(chatContent.height());
    if(message.updateList) {
        updateList();
    }
}
</script>
</h:body>
</html>
