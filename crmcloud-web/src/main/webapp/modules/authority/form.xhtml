<?xml version='1.0' encoding='UTF-8' ?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
    <style>
        .content {
            width: 100%;
        }
        #mainContent{
            width: 100%;
        }  
    </style>
    <h:outputFormat rendered="#{empty authorityController.selectedRole}">
        <div id="pageTitle">#{companyBundle['label.authority.title']} #{msg['symbol.paren.left']}#{msg['label.create']}#{msg['symbol.paren.right']}</div>
    </h:outputFormat>
    <h:outputFormat rendered="#{not empty authorityController.selectedRole}">
        <div id="pageTitle">#{companyBundle['label.authority.title']} #{msg['symbol.paren.left']}#{msg['label.edit']}#{msg['symbol.paren.right']}</div>
    </h:outputFormat>
    <h:form style="width: 100%;">
        <h:panelGrid width="100%" styleClass="page-header">
            <f:facet name="header">
                <!-- Content Header (Page header) -->
                <div class="row">
                    <div class="col-md-6">
                        <h1>
                            #{companyBundle['label.authority.title']}
                            <small>
                                <h:outputFormat rendered="#{empty authorityController.selectedRole}">
                                    #{msg['label.create']}
                                </h:outputFormat>
                                <h:outputFormat rendered="#{not empty authorityController.selectedRole}">
                                    #{msg['label.edit']}
                                </h:outputFormat>
                            </small>
                        </h1>
                    </div>
                    <div class="col-md-6 text-right">
                        <p:commandButton actionListener="#{authorityController.reload()}"
                                         value="#{msg['label.back']}"
                                         title="#{msg['label.back']}"
                                         icon="fa fa-chevron-circle-left" process="@this"
                                         update=":mainContent" onstart="start()" onsuccess="finish()">
                            <f:param name="force" value="true"/>
                            <p:confirm header="#{msg['label.confirm']}" message="#{msg['label.message.confirm.back']}" icon="ui-icon-alert"/>
                        </p:commandButton>
                        
                        <p:commandButton  id="btnDel" actionListener="#{authorityController.remove(authorityController.selectedRole)}"
                                         value="#{msg['label.delete']}" icon="fa fa-trash" process="@this"
                                         update=":growl, mainContent" onstart="start()" onsuccess="finish()"
                                         rendered="#{not empty authorityController.selectedRole and sec.hasMethod('AuthorityController','delete')}">
                            <p:confirm header="#{companyBundle['label.authority.confirm']}" message="#{companyBundle['label.authority.confirm.question']}" icon="ui-icon-alert" />
                            <f:param name="force" value="true"/>
                        </p:commandButton>
                        <p:commandButton id="btnSave" value="#{msg['label.save']}" actionListener="#{authorityController.save()}"
                                         update=":growl, mainContent"
                                         title="#{msg['label.save']}" icon="fa fa-check-circle" onstart="start()" onsuccess="finish()">
                            <f:param name="force" value="true"/>
                        </p:commandButton>
                        <p:commandButton value="#{msg['label.print']}" title="#{msg['label.print']}" icon="fa fa-print" rendered="#{not empty authorityController.selectedRole}">
                            <p:printer target="printArea"/>
                        </p:commandButton>
                    </div>
                </div>
                <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" id="cfmAuthority">
                    <p:commandButton value="#{msg['label.yes']}" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
                    <p:commandButton value="#{msg['label.no']}" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
                </p:confirmDialog>
            </f:facet>
        </h:panelGrid>
        <p:outputPanel id="printArea" styleClass="box">
            <div class="box-body">
                <table class="table">
                    <tbody>
                        <tr>
                            <td width="80">
                                <p:column styleClass="label-field"><p:outputLabel value="#{companyBundle['label.authority.name']}" styleClass="required"/></p:column>
                            </td>
                            <td colspan="3">
                                <p:inputText id="role_name" styleClass="input_text_name" placeholder="#{companyBundle['label.authority.name']}" 
                                             value="#{empty authorityController.selectedRole ? authorityController.roleName : authorityController.selectedRole.roleName}" 
                                             required="true" maxlength="100" label="#{companyBundle['label.authority.name']}">
                                    <f:validator validatorId="gnext.validator.RequiredValidator" />
                                    <f:validator validatorId="gnext.validator.LengthValidator" />
                                    <f:attribute name="max" value="100"/>
                                    <f:attribute name="title" value="#{companyBundle['label.authority.name']}"/>
                                </p:inputText>
                                <p:message for="role_name" />
                            </td>
                        </tr>
                        <tr>
                            <td valign="top">
                                <p:outputLabel value="#{companyBundle['label.authority']}"/>
                            </td>
                            <td width="40%">
                                <p:selectManyMenu value="#{authorityController.selectedGroup}"
                                                  var="t" filter="true" filterMatchMode="contains" 
                                                  showCheckbox="true" style="width: 100%" scrollHeight="100">
                                    <f:selectItems value="#{authorityController.groupList}" var="g" 
                                                   itemLabel="#{g.groupName}" itemValue="#{g}" />
                                    <p:column>
                                        <h:outputText value="#{t.groupName}" />
                                    </p:column>
                                </p:selectManyMenu>
                            </td>
                            <td valign="top" width="80"><p:outputLabel value="#{msg['label.user']}"/></td>
                            <td>
                                <p:selectManyMenu value="#{authorityController.selectedMember}"
                                                  var="t" filter="true" filterMatchMode="contains" showCheckbox="true"
                                                  style="width: 100%" scrollHeight="100">
                                    <f:selectItems value="#{authorityController.memberList}" var="m" 
                                                   itemLabel="#{m.memberNameFull}" 
                                                   itemValue="#{m}" />
                                    <p:column>
                                        <h:outputText value="#{t.memberNameFull}" />
                                    </p:column>
                                </p:selectManyMenu>
                            </td>
                        </tr>
                    </tbody>    
                </table>
                <div class="flex_1" style="overflow: auto;">
                    <p:treeTable id="authorityTree" styleClass="authorityTree" value="#{authorityController.authList}" var="document" scrollable="true">
                        <f:facet name="header">
                            #{companyBundle['label.authority.rule']}
                        </f:facet>
                        <p:column style="width: 280px" styleClass="col-first">
                            <b><h:outputText value="#{msg['label.menu.'.concat(document.name)]}" rendered="#{!document.name.equals('FIRST_ROW')}"/></b>
                            <p:selectBooleanCheckbox value="#{authorityController.roleRows[document.id]}" 
                                                     styleClass="pull-right" 
                                                     rendered="#{!document.name.equals('FIRST_ROW') and document.action.size() > 0}">
                                <p:ajax listener="#{authorityController.toggleRoleRow}" update="authorityTree" onstart="start()" onsuccess="finish()" oncomplete="$.fn.smoothElements();"/>
                            </p:selectBooleanCheckbox>
                        </p:column>
                        <c:forEach var="label" items="#{authorityController.roleColumnLabels}" varStatus="loop">
                            <p:column styleClass="text-center col-role-button" style="width: 100px;height: 20px">
                                <p:selectBooleanCheckbox value="#{authorityController.roleColumns[label]}" 
                                                         rendered="#{document.name.equals('FIRST_ROW')}">
                                    <p:ajax event="change" listener="#{authorityController.toggleRoleColumn(label)}" update="authorityTree" onstart="start()" onsuccess="finish()" oncomplete="$.fn.smoothElements();"/>
                                </p:selectBooleanCheckbox>
                                <p:selectBooleanButton
                                    style="width: 100%;height: 100%; padding: 2px 2px 2px 2px !important;"
                                    value="#{document.getActionByLabel(label).selected}"
                                    onLabel="#{msg['label.menu.'.concat(document.getActionByLabel(label).name)]}" 
                                    offLabel="#{msg['label.menu.'.concat(document.getActionByLabel(label).name)]}"
                                    rendered="#{!document.name.equals('FIRST_ROW') and document.hasActionByLabel(label)}"
                                    styleClass="btn-authority"> <!-- and document.hasAction(loop.index) -->
                                    <p:ajax listener="#{authorityController.toggleRoleCell}" update="authorityTree" onstart="start()" onsuccess="finish()" oncomplete="$.fn.smoothElements();"/>
                                </p:selectBooleanButton>
                            </p:column>
                        </c:forEach>
                        <p:column styleClass="col-last"></p:column>
                    </p:treeTable>
                </div>
            </div><!-- /.box-body -->
        </p:outputPanel><!-- /.box -->
    </h:form>
</ui:composition>

