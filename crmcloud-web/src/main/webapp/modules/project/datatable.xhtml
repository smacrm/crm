<?xml version='1.0' encoding='UTF-8' ?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:pe="http://primefaces.org/ui/extensions">
    <c:set var="resizable" value="#{empty resizable ? false : resizable}" scope="request" />
    <c:set var="rowsPerPageTemplate" value="#{configController.getConfig('DATATABLE_ROW_PER_PAGE')}" scope="session" />
    <c:set var="rows" value="#{configController.getConfig('DATATABLE_DEFAULT_PER_PAGE')}" scope="session" />
    <c:set var="liveSearchVisibleColumns" value="${ais.liveSearchVisibleColumns}" scope="request" />
    <p:dataTable id="issueListData" styleClass="flex flex_1_1 flex_column" var="i" value="#{ais.issues}"
        resizableColumns="#{resizable}" resizeMode="expand" scrollable="true"
        paginator="true" paginatorTemplate="#{layout.paginatorTemplate}" currentPageReportTemplate="#{layout.currentPageReportTemplate}"
        rowsPerPageTemplate="#{rowsPerPageTemplate}" rows="#{rows}" pageLinks="5" rowHover="true" emptyMessage="#{msg['label.data.empty']}"
        widgetVar="dataTableWidget" rowIndexVar="issueIndex">
        <p:ajax event="page" oncomplete="changeIssueItemLampColor();" onstart="PF('blockUIWidget').block()" onsuccess="PF('blockUIWidget').unblock()"/>
        <p:ajax event="sort" oncomplete="changeIssueItemLampColor();" onstart="PF('blockUIWidget').block()" onsuccess="PF('blockUIWidget').unblock()"/>
        <p:ajax event="colResize" listener="#{projectController.onResize}" oncomplete="resize(); changeIssueItemLampColor();"/>
        
        <p:column
            styleClass="table-action td_minus ##{i['lamp_color']}"
            resizable="false"
            rendered="#{(sec.isMaster() or sec.hasMethod('IssueController', 'update') or sec.hasMethod('CustomerController', 'update'))}">
            <c:choose>
                <c:when test="#{loginController.member.companyCustomerMode}">
                    <h:commandLink
                        target="_blank"
                        actionListener="${customerController.openTab}"
                        action="#{customerController.outcome(i['cust_id'])}"
                        title="#{msg['label.edit']}"
                        styleClass="ui-icon ui-icon-pencil commandLinkListRemoveScript #{currentIssueEditing ? 'ui-state-disabled' : ''}">
                        <f:param name="custId" value="#{i['cust_id']}"/>
                        <f:param name="force" value="true"/>
                        </h:commandLink>
                </c:when>
                <c:otherwise>
                    <c:set var="profile" value="#{issueGlobalStatus.getEditingProfile(issueController.companyId, i['issue_id'])}"/>
                    <c:set var="currentIssueEditing" value="#{issueGlobalStatus.isEditing(issueController.companyId, i['issue_id']) and profile.memberId ne loginController.member.userId}"/>
                    <h:commandLink 
                        target="_blank"
                        actionListener="#{issueController.edit()}"
                        action="#{issueController.outcome(i['issue_id'])}"
                        title="#{not currentIssueEditing ? msg['label.edit'] : issue['label.issue.editing.warning.static']}"
                        styleClass="ui-icon ui-icon-pencil commandLinkListRemoveScript #{currentIssueEditing ? 'ui-state-disabled' : ''}">
                        <f:param name="id" value="#{i['issue_id']}" />
                        <f:param name="issueIdx" value="#{issueIndex}" />
                        <f:param name="force" value="true"/>
                    </h:commandLink>
                </c:otherwise>
            </c:choose>
        </p:column>

        <c:forEach items="${liveSearchVisibleColumns}" var="c" varStatus="idx">
            <p:column headerText="#{c.label}" 
                      style="#{empty projectController.columnWidth[c.value] ? 'width: 130px;': 'width:'.concat(projectController.columnWidth[c.value]).concat('px;')}#{!empty i['lamp_test_color'] ? 'color: #'.concat(i['lamp_test_color']) : ''}"
                      id="#{c.value}"
                      sortBy="${i[c.value]}">
                <c:choose>
                    <c:when test="#{c.value eq 'cust_status'}">
                        <h:outputText value="${msg['label.correction_application']}" rendered="#{i[c.value] eq '1'}" />
                        <h:outputText value="${msg['label.apply_deletion']}" rendered="#{i[c.value] eq '2'}" />
                        <h:outputText value="${msg['label.pending']}" rendered="#{i[c.value] eq '3'}" />
                        <h:outputText value="${msg['label.approval']}" rendered="#{i[c.value] eq '4'}" />
                        <h:outputText value="${msg['label.not_show']}" rendered="#{i[c.value] eq '5'}" />
                    </c:when>
                    <c:otherwise>
                <c:choose>
                    <c:when test="${idx.index == 0}">
                        <c:choose>
                            <!-- công ty là khách hàng đặc biệt. -->
                            <c:when test="#{loginController.member.companyCustomerMode}">
                                <p:selectBooleanCheckbox value="${i[c.value] eq 'on'}" rendered="${i[c.value] eq 'on'}" disabled="true"/>
                                <h:outputText escape="false" value="${customerController.breakDataToNewLine(i[c.value])}" rendered="${i[c.value] ne 'on'}"/>
                            </c:when>
                            <!-- công ty là loại bình thường. -->
                            <c:otherwise>
                                <h:commandLink 
                                    target="_blank"
                                    actionListener="#{issueController.show()}"
                                    action="#{issueController.outcome(i['issue_id'])}"
                                    disabled="#{not (sec.isMaster() or sec.hasMethod('IssueController', 'view'))}"
                                    title="#{msg['label.show']}"
                                    value="${customerController.breakDataToNewLine(i[c.value])}"
                                    style="font-weight: bold; color: blue;">
                                    <f:param name="id" value="#{i['issue_id']}" />
                                    <f:param name="issueIdx" value="#{issueIndex}" />
                                    <f:param name="force" value="true"/>
                                </h:commandLink>
                            </c:otherwise>
                        </c:choose>   
                    </c:when>
                    <c:otherwise>
                        <c:choose>
                            <c:when test="#{!empty c.description and (c.description eq 'view_text_area')}">
                                <p:inputTextarea
                                    rows="2"
                                    autoResize="false"
                                    readonly="true"
                                    value="${customerController.breakDataToNewLine(i[c.value])}"
                                    style="width: 100%;#{!empty i['lamp_test_color'] ? 'color: #'.concat(i['lamp_test_color']) : ''}"
                                    styleClass="font_weight_normal inputTextareaNotBorder" />
                            </c:when>
                            <c:otherwise>
                                <p:selectBooleanCheckbox value="${i[c.value] eq 'on'}" rendered="${i[c.value] eq 'on'}" disabled="true"/>
                                <h:outputText escape="false" value="${customerController.breakDataToNewLine(i[c.value])}" rendered="${i[c.value] ne 'on'}"/>
                            </c:otherwise>
                        </c:choose>
                    </c:otherwise>
                </c:choose>
                    </c:otherwise>
                </c:choose>
            </p:column>
        </c:forEach>
    </p:dataTable>
    
    <pe:blockUI target="issueListData" content="blockUIContent" widgetVar="blockUIWidget"/>  
    <ui:include src="/blocks/infile/blockui.xhtml"/>
    
    <h:outputScript id="issueListDataScript">
        var changeIssueItemLampColor = function(){
            $('#issueListData .td_minus').each(function(){
                var tr = $(this).parent();
                var className = $(this).attr('class');
                var cls = className.split(' ');
                var cl = cls[cls.length-1];
                if(cl.indexOf('#') > -1) {
                    if(cl.length > 2) $(tr).css('background', cl);
                }
            });
        };
        $(document).ready(function(){
            changeIssueItemLampColor();
        });
        try{
            mojarra.jsfcljs = function(f, pvp, t){
                mojarra.apf(f, pvp);
                var ft = f.target;
                var fa = f.action;
                if(t){
                    f.target = t;
                }

                //customize for action "open issue as new tab"
                if(t === '_blank' &amp;&amp; pvp.hasOwnProperty('issueId') &amp;&amp; !isNaN(pvp.issueId)){
                    var href = window.location.href;
                    var url  = href.split('?s=');
                    f.action = url[0];
                }

                f.submit();
                f.target = ft;
                f.action = fa;

                mojarra.dpf(f);
            };
        }catch(e){
            // mojarra is not work at the first time login of new member
        }
    </h:outputScript>
</ui:composition>

