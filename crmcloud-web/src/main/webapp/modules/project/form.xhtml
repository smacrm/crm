<?xml version='1.0' encoding='UTF-8' ?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
    <h:outputFormat rendered="#{empty projectController.project.listId}">
        <div id="pageTitle">${issue['label.page.project']}#{msg['symbol.paren.left']}#{msg['label.create']}#{msg['symbol.paren.right']}</div>
    </h:outputFormat>
    <h:outputFormat rendered="#{not empty projectController.project.listId}">
        <div id="pageTitle">${issue['label.page.project']}#{msg['symbol.paren.left']}#{msg['label.edit']}#{msg['symbol.paren.right']}</div>
    </h:outputFormat>
    
    <h:form id="projectList" onkeypress="if (event.keyCode === 13 &amp;&amp; $(event.target).prop('tagName') !== 'TEXTAREA') { return false; }">
        <h:panelGrid width="100%" styleClass="page-header">
            <f:facet name="header">
                <!-- Content Header (Page header) -->
                <div class="row">
                    <div class="col-md-6">
                        <h1>
                            <h1>${issue['label.page.project']}<small>${not empty projectController.project.listId ? msg['label.update'] : msg['label.create'] }</small></h1>
                        </h1>
                    </div>
                    <div class="col-md-6 text-right">
                        <p:commandButton actionListener="#{projectController.reload()}"
                                         value="#{msg['label.back']}" icon="fa fa-chevron-circle-left" process="@this"
                                         update="mainContent, :sidebarLeft:menuListGroup, :sidebarLeft:menuSearchGroup" 
                                         onstart="start()" onsuccess="finish()">
                            <f:param name="force" value="true"/>
                            <p:confirm header="#{msg['label.confirm']}" message="#{msg['label.message.confirm.back']}" icon="ui-icon-alert"/>
                        </p:commandButton>
                        <p:commandButton actionListener="#{projectController.remove(projectController.project)}"
                                         value="#{msg['label.delete']}" icon="fa fa-trash" process="@this"
                                         update=":growl, mainContent, :sidebarLeft:menuListGroup, :sidebarLeft:menuSearchGroup" 
                                         onstart="start()" onsuccess="finish(); $('#sidebar-menu .close-edit-project').trigger('click');"
                                         rendered="#{not empty projectController.project.listId and (sec.isMaster() or sec.hasMethod('ProjectController', 'DELETE'))}">
                            <p:confirm header="#{msg['label.confirm']}" message="#{msg['label.confirm.delete']}" icon="ui-icon-alert" />
                            <f:param name="force" value="true"/>
                        </p:commandButton>


                        <p:commandButton value="#{msg['label.create']}" actionListener="#{projectController.doCreate()}"
                                         update=":growl, mainContent, :sidebarLeft:menuListGroup, :sidebarLeft:menuSearchGroup"
                                         title="#{msg['label.create']}" icon="fa fa-check-circle" onstart="start()" onsuccess="finish()"
                                         rendered="#{empty projectController.project.listId}" style="display: none !important"
                                         styleClass="saveAction">
                            <f:param name="force" value="true"/>
                        </p:commandButton>
                        <p:commandButton value="#{msg['label.create']}" title="#{msg['label.create']}" icon="fa fa-check-circle"
                                         rendered="#{empty projectController.project.listId}" styleClass="updateSearchData"/>


                        <p:commandButton value="#{msg['label.update']}" actionListener="#{projectController.doUpdate()}"
                                         update=":growl, mainContent, :sidebarLeft:menuListGroup, :sidebarLeft:menuSearchGroup"
                                         title="#{msg['label.update']}" icon="fa fa-check-circle" onstart="start()" onsuccess="finish()"
                                         rendered="#{not empty projectController.project.listId}" style="display: none !important" 
                                         styleClass="saveAction">
                            <f:param name="force" value="true"/>
                        </p:commandButton>
                        <p:commandButton value="#{msg['label.update']}" type="button" title="#{msg['label.update']}" icon="fa fa-check-circle"
                                         rendered="#{not empty projectController.project.listId}" styleClass="updateSearchData"/>
                        <p:commandButton value="#{msg['label.print']}" title="#{msg['label.print']}" icon="ui-icon-print" type="button" onstart="start()" onsuccess="finish()" rendered="#{not empty projectController.project.listId}">
                            <p:printer target="projectList"/>
                        </p:commandButton>
                    </div>
                </div>
                <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                    <p:commandButton value="#{msg['label.yes']}" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
                    <p:commandButton value="#{msg['label.no']}" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
                </p:confirmDialog>
            </f:facet>
        </h:panelGrid>
        <div class="box">
            <div class="box-body flex flex_column">
                <div class="flex_0">
                    <div class="col-md-2 col-lg-1">
                        <p:outputLabel value="#{msg['label.proj.form.list.name']}" for="list_name"/>
                    </div>
                    <div class="col-md-10 col-lg-11">
                        <p:inputText id="list_name" placeholder="#{msg['label.proj.form.list.name']}" value="#{projectController.project.listName}" 
                                     required="true" styleClass="col-md-4" maxlength="70" label="#{msg['label.proj.form.list.name']}">
                            <f:validator validatorId="gnext.validator.RequiredValidator" />
                            <f:validator validatorId="gnext.validator.LengthValidator" />
                            <f:attribute name="min" value="4"/>
                            <f:attribute name="max" value="70"/>
                            <f:attribute name="title" value="#{msg['label.proj.form.list.name']}"/>
                        </p:inputText>
                    </div>
                    <p:outputPanel class="col-md-6" rendered="#{projectController.project.listType eq 1}">
                        <p:outputPanel class="col-md-6">
                            <p:outputLabel value="#{msg['label.proj.form.authority']}"/>
                            <p:selectManyMenu value="#{projectController.selectedGroup}"
                                              var="t" filter="true" filterMatchMode="contains" 
                                              showCheckbox="true" style="width: 100%" scrollHeight="100">
                                <f:selectItems value="#{projectController.groupList}" var="g" 
                                               itemLabel="#{g.groupName}" itemValue="#{g}" />
                                <p:column>
                                    <h:outputText value="#{t.groupName}" />
                                </p:column>
                            </p:selectManyMenu>
                        </p:outputPanel>
                        <p:outputPanel class="col-md-6">
                            <p:outputLabel value="#{msg['label.proj.form.user']}"/>
                            <p:selectManyMenu value="#{projectController.selectedMember}"
                                              var="t" filter="true" filterMatchMode="contains" showCheckbox="true"
                                              style="width: 100%" scrollHeight="100">
                                <f:selectItems value="#{projectController.memberList}" var="m" 
                                               itemLabel="#{m.memberNameFirst} #{m.memberNameLast}" 
                                               itemValue="#{m}" />
                                <p:column>
                                    <h:outputText value="#{t.memberNameFirst} #{t.memberNameLast}" />
                                </p:column>
                            </p:selectManyMenu>
                        </p:outputPanel>
                    </p:outputPanel>
                    <p:outputPanel class="#{projectController.project.listType eq 3 ? 'col-md-4' : 'col-md-6'}">
                        <p:outputLabel value="&#160;"/>
                        <p:pickList id="dynamicColumns" value="#{projectController.columns}" var="col" 
                                    itemLabel="#{not col.name.contains('.cust_') ? issue[col.name] : customer[col.name]}" itemValue="#{col.id}"
                                    itemDisabled="#{(not col.name.contains('.cust_') ? issue[col.name] : customer[col.name]).startsWith('---')}"
                                    responsive="true" showTargetFilter="true" showSourceFilter="true" filterMatchMode="contains"
                                    converter="DynamicColumnConverter">
                            <p:ajax event="transfer" listener="#{projectController.onTransferPickListDynamicCol}" update="dynamicColumns"/>
                        </p:pickList>
                    </p:outputPanel>
                    <p:outputPanel class="col-md-8" rendered="#{projectController.project.listType eq 3}">
                        <p:outputLabel value=""/>
                        <div class="box box-solid box-search">
                            <div class="box-header with-border">
                                <h3 class="box-title">#{msg['label.search.title']}</h3> #{msg['symbol.colon']}<code></code>
                            </div>
                            <div class="box-body">
                                <div id="search-filter"></div>
                            </div>
                        </div>
                    </p:outputPanel>
                    <p:outputPanel rendered="#{projectController.project.listType eq 1}">
                        <div class="box box-solid box-search no-padding">
                            <div class="box-header with-border" data-widget="collapse">
                                <h3 class="box-title">#{msg['label.search.title']}</h3>
                                #{msg['symbol.colon']}<code></code>
                                <div class="box-tools pull-right">
                                    <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-plus"></i></button>
                                </div>
                            </div>
                            <div class="box-body">
                                <div id="search-filter"></div>
                            </div>
                        </div>
                    </p:outputPanel>
                    <div class="clearfix"></div>
                    <div class="text-center" style="position: relative;">
                        <p:panel id="projectSearchPeriodId" style="border: none;">
                        <table style="margin-bottom:-3em">
                            <tr>
                                <td style="padding-left:0.5em;">
                            <h:inputText id="searchDataJson" value="#{projectController.project.listSearchData}" styleClass="searchDataJson" style="display: none !important"/>
                            <c:choose>
                                <c:when test="#{loginController.member.companyCustomerMode}">
                                    <h:outputLabel value="#{msg['label.created_time']}" style="font-size: 12px;"/>
                                </c:when>
                                <c:otherwise>
                                    <h:outputLabel value="#{issue['label.issue_receive_date.cond']}" style="font-size: 12px;"/>
                                </c:otherwise>
                            </c:choose>
                            <font color="red" style="font-size: 12px; font-weight: normal;">*</font>
                            <p:spacer width="5"/>
                            <p:calendar
                                id="fromDateSearch"
                                disabled="#{projectController.isSearchPeriod}"
                                value="#{projectController.project.dateFrom}"
                                pattern="yyyy/MM/dd" size="12" 
                                maxdate="#{projectController.project.dateTo}"
                                required="true"
                                label="#{issue['label.issue_receive_date.from']}"
                                placeholder="#{issue['label.issue_receive_date.from']}">
                                <p:ajax event="dateSelect" oncomplete="$('.btn-search').click()" update="toDateSearch" />
                            </p:calendar>
                            <h:outputText value="~" style="font-size: 12px; font-weight: normal; display: inline-block; margin: 0 5px;"/>
                            <p:calendar
                                id="toDateSearch"
                                disabled="#{projectController.isSearchPeriod}"
                                widgetVar="toDateSearch"
                                maxdate="toDateSearch.today()" size="12" 
                                required="true"
                                label="#{issue['label.issue_receive_date.to']}"
                                placeholder="#{issue['label.issue_receive_date.to']}"
                                value="#{projectController.project.dateTo}"
                                mindate="#{projectController.project.dateFrom}" pattern="yyyy/MM/dd">
                                <p:ajax event="dateSelect" oncomplete="$('.btn-search').click()" update="fromDateSearch"/>
                            </p:calendar>
                                </td>
                                <td style="padding-left:1.5em;">
                        <!-- 期間で検索 -->
                        <h:panelGrid>
                            <p:row>
                               <p:column>
                                   <p:selectBooleanCheckbox value="#{projectController.isSearchPeriod}" >
                                       <p:ajax update="projectSearchPeriodId" listener="#{projectController.changeSearchPeriod}" />
                                   </p:selectBooleanCheckbox>
                                   <h:outputLabel value="#{issue['label.issue_search_from_now']}" style="font-size: 12px;padding-left:0.2em;padding-rigth:0.2em;"/>
                               </p:column>
                                <p:column>
                                    <p:inputText
                                        id="listSearchPeriodId"
                                        disabled="#{projectController.isSearchPeriod==null || !projectController.isSearchPeriod}"
                                        value="#{projectController.searchPeriod}"
                                        style="width: 2.5em !important;" />
                                    <p:slider
                                        disabled="#{projectController.isSearchPeriod==null || !projectController.isSearchPeriod}"
                                        for="listSearchPeriodId" maxValue="36" />
                                </p:column>
                            </p:row>
                        </h:panelGrid>
                                </td>
                                <td style="padding-left:0.3em;vertical-align: top;">
                                    <p:selectOneButton
                                        disabled="#{projectController.isSearchPeriod==null || !projectController.isSearchPeriod}"
                                        value="#{projectController.searchPeriodBeforeAfter}"
                                        style="border-left: 0 !important;">
                                        <f:selectItem itemLabel="#{issue['label.issue_search_months_ago']}" itemValue="false" />
                                        <f:selectItem itemLabel="#{issue['label.issue_search_months_later']}" itemValue="true" />
                                    </p:selectOneButton>
                                </td>
                            </tr>
                        </table>
                        </p:panel>

                        <p:commandLink actionListener="#{ais.search(projectController.project, projectController.columns)}" 
                                       style="display:none" styleClass="search-action" 
                                       onstart="start()" onsuccess="finish();" oncomplete="resize(); changeIssueItemLampColor();"
                                       update="issueListData, :growl"  process="searchDataJson, dynamicColumns, @this"/>

                        <p:commandButton value="#{msg['label.search']}" type="button" icon="fa fa-search" styleClass="btn-search"></p:commandButton>
                        <div class="clearfix"></div>
                    </div>
                </div>
                <div class="row flex flex_1_1" style="margin-top: 10px">
                    <div class="col-md-12  flex flex_1_1" style="height: 570px">
                        <ui:include src="/modules/project/datatable.xhtml">
                            <ui:param name="resizable" value="true"/>
                        </ui:include>
                    </div>
                </div>
            </div><!-- /.box-body -->
        </div><!-- /.box -->

        <h:outputScript library="js" name="search-filter.js"/>

        <p:outputPanel rendered="#{projectController.project.listType eq 1}">
            <script type="text/javascript">
                var searchFilterOpts = {
                    fields: #{ais.columnJson},
                    data: $('.searchDataJson').val(),
                    maxGroup: 3,
                    maxRow: 1,
                    displayQuery: true,
                    queryContainer: $("#search-filter").closest('.box.box-search').find('.box-header code'),
                    langs: {
                        AND: '#{msg['label.condition.and']}',
                        OR: '#{msg['label.condition.or']}',
                        LIKE: '#{msg['label.condition.like']}',
                        LIKE_START: '#{msg['label.condition.like_start']}',
                        LIKE_END: '#{msg['label.condition.like_end']}',
                        NOT_LIKE: '#{msg['label.condition.not_like']}',
                        BLANK: '#{msg['label.condition.blank']}',
                        NOT_BLANK: '#{msg['label.condition.not_blank']}'
                    }
                };
            </script>
        </p:outputPanel>
        <p:outputPanel rendered="#{projectController.project.listType eq 3}">
            <script type="text/javascript">
                var searchFilterOpts = {
                    fields: #{ais.columnJson},
                    data: $('.searchDataJson').val(),
                    maxGroup: 4,
                    maxRow: 2,
                    displayQuery: true,
                    queryContainer: $("#search-filter").closest('.box.box-search').find('.box-header code'),
                    langs: {
                        AND: '#{msg['label.condition.and']}',
                        OR: '#{msg['label.condition.or']}',
                        LIKE: '#{msg['label.condition.like']}',
                        LIKE_START: '#{msg['label.condition.like_start']}',
                        LIKE_END: '#{msg['label.condition.like_end']}',
                        NOT_LIKE: '#{msg['label.condition.not_like']}',
                        BLANK: '#{msg['label.condition.blank']}',
                        NOT_BLANK: '#{msg['label.condition.not_blank']}'
                    }
                };
            </script>
        </p:outputPanel>

        <script type="text/javascript">
            jQuery(document).ready(function ($) {
                var sf = $("#search-filter").searchFilter(searchFilterOpts);

                $(".btn-search").click(function (event) {
                    event.preventDefault();
                    var data = sf.data('searchFilter').getData();
                    $('.searchDataJson').val(data);
                    $(".search-action").trigger('click');
                });
                $(".updateSearchData").click(function () {
                    var data = sf.data('searchFilter').getData();
                    $('.searchDataJson').val(data);

                    $(".saveAction").trigger('click');
                    $("#sidebar-menu .close-edit-project").trigger('click');
                });
                
                //Check first sort column
                // Giam dan: ui-icon-triangle-1-s
                // Tang dan: ui-icon-triangle-1-n
                if($('#projectList\\:issueListData #projectList\\:issueListData_head th.ui-state-active').length === 0){
                    var th = $('#projectList\\:issueListData th#projectList\\:issueListData\\:issue_receive_date');
                    th.addClass('ui-state-active');
                    th.find('span.ui-sortable-column-icon').addClass('ui-icon-triangle-1-s');
                }
            });
        </script>
    </h:form>
</ui:composition>

