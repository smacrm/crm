<?xml version='1.0' encoding='UTF-8' ?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:a="http://xmlns.jcp.org/jsf/passthrough"
                xmlns:p="http://primefaces.org/ui"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:pe="http://primefaces.org/ui/extensions" >
    <div id="pageTitle">${msg['label.menu.ReportController']}</div>
    <h:form id="reportPanel" styleClass="reportPanel">
        <h:panelGrid width="100%" styleClass="page-header">
            <f:facet name="header">
                <!-- Content Header (Page header) -->
                <div class="row">
                    <div class="col-md-6">
                        <h1>${msg['label.menu.ReportController']}</h1>
                    </div>
                    <div class="col-md-6 text-right">

                    </div>
                </div>
            </f:facet>
        </h:panelGrid>
        <p:remoteCommand name="cmdSaveChartImage" actionListener="#{reportController.saveChartImage()}"/>
        <p:remoteCommand name="cmdExport" actionListener="#{reportController.export()}" 
                         update=":reportPanel:reportChart, :reportPanel:reportScriptChart, :reportPanel:exportTable"/>
        <p:tabView binding="#{reportController.tabView}" id="tabview">
            <p:ajax event="tabChange" listener="#{reportController.onSPTabChange}"/>
            <p:tab title="#{report['label.report.1.title']}">
                <p>&#160;</p>
                <div class="col-md-12">
                <div class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">#{report['label.report.yearmonth']}</label>
                        <div class="col-sm-10">
                            <p:calendar value="#{reportController.fromDate1}" navigator="true" required="false" mode="inline"
                                        locale="#{localeController.locale}" >
                                <p:ajax event="viewChange" listener="#{reportController.calendarViewChange}" update="@this"/>
                            </p:calendar>
                            <span class="help-block" style="position: absolute;left: 230px;top: 3px;">#{report['label.note']}</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-10">
                            <p:commandButton actionListener="#{reportController.search(true)}" value="#{report['label.report.create']}" icon="fa fa-bar-chart"
                                update=":reportPanel:reportChart, :reportPanel:reportScriptChart" onstart="start()" onsuccess="finish()"
                                rendered="#{sec.hasMethod('ReportController', 'search')}"
                                />
                            <div class="btn-group">
                                <p:commandLink onclick="doExport()" styleClass="btn btn-success dropdown-toggle" 
                                               a:data-toggle="dropdown" a:aria-haspopup="true" a:aria-expanded="false"
                                               style="color: #fff !important; padding: 4px 12px;" onsuccess="finishProcessExport()"
                                               rendered="#{sec.hasMethod('ReportController', 'download')}">
                                    <i class="fa fa-download"></i>
                                    #{msg['label.download']} <span class="caret"></span>
                                </p:commandLink>
                                <ul class="dropdown-menu">
                                    <li><p:commandLink styleClass="doExportBtn" ajax="false" onclick="saveChartImage()" onstart="start()" onsuccess="finish()">
                                            <i class="fa fa-file-excel-o" aria-hidden="true"></i> Excel
                                            <pe:exporter type="xlsx" target=":reportPanel:exportTable" fileName="#{reportController.exportedTitle}" 
                                                         postProcessor="#{reportController.postProcessXLS}" encoding="UTF-8"/>
                                            <img src="javax.faces.resource/loading.gif.xhtml?ln=images" height="20px" class="pull-right"/>
                                        </p:commandLink>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                    </div>
            </p:tab>
            <p:tab title="#{report['label.report.2.title']}">
                <p>&#160;</p>
                <div class="col-md-12">
                <div class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">#{report['label.report.yearmonth']}</label>
                        <div class="col-sm-10">
                            <p:calendar value="#{reportController.fromDate2}" navigator="true" required="false" mode="inline"
                                        locale="#{loginController.member.locale}" >
                                <p:ajax event="viewChange" listener="#{reportController.calendarViewChange}" update="@this"/>
                            </p:calendar>
                            <span class="help-block" style="position: absolute;left: 230px;top: 3px;">#{report['label.note']}</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-10">
                            <p:commandButton actionListener="#{reportController.search(true)}" value="#{report['label.report.create']}" icon="fa fa-bar-chart"
                                update=":reportPanel:reportChart, :reportPanel:reportScriptChart" onstart="start()" onsuccess="finish()" 
                                rendered="#{sec.hasMethod('ReportController', 'search')}"/>
                            <div class="btn-group">
                                <p:commandLink onclick="doExport()" styleClass="btn btn-success dropdown-toggle" 
                                               a:data-toggle="dropdown" a:aria-haspopup="true" a:aria-expanded="false"
                                               style="color: #fff !important; padding: 4px 12px;" onsuccess="finishProcessExport()"
                                               rendered="#{sec.hasMethod('ReportController', 'download')}">
                                    <i class="fa fa-download"></i>
                                   #{msg['label.download']} <span class="caret"></span>
                                </p:commandLink>
                                <ul class="dropdown-menu">
                                    <li><p:commandLink styleClass="doExportBtn" ajax="false" onclick="saveChartImage()" onstart="start()" onsuccess="finish()">
                                            <i class="fa fa-file-excel-o" aria-hidden="true"></i> Excel
                                            <pe:exporter type="xlsx" target=":reportPanel:exportTable" fileName="#{reportController.exportedTitle}" 
                                                         postProcessor="#{reportController.postProcessXLS}" encoding="UTF-8"/>
                                            <img src="javax.faces.resource/loading.gif.xhtml?ln=images" height="20px" class="pull-right"/>
                                        </p:commandLink>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </p:tab>
        </p:tabView>
        <p:dataTable id="exportTable" value="#{reportController.report.rows}" var="item" style="display: none" rendered="#{sec.hasMethod('ReportController', 'download')}">
            <f:facet name="header">  
                <h:outputText value="#{reportController.getSelectedTitle()}"/>  
            </f:facet>
            <p:columnGroup type="header">  
                <p:row>
                    <!-- Header columns (levels) -->
                    <c:forEach begin="1" end="#{reportController.maxHeaderColumn}" varStatus="loop">
                        <p:column headerText="#{reportController.getHeaderText(loop.index)}" rowspan="2" style="center"/>
                    </c:forEach>

                    <!-- Month columns -->
                    <c:forEach items="#{reportController.monthColumns}" var="month">
                        <p:column headerText="#{month}#{report['label.report.month']}" colspan="3"/>
                    </c:forEach>

                    <p:column headerText="#{report['label.total.year']}" colspan="3"/> 
                </p:row>  

                <p:row>
                    <c:forEach begin="0" end="12">
                        <p:column headerText="#{report['label.current.year']}"/>
                        <p:column headerText="#{report['label.prev.year']}"/>
                        <p:column headerText="#{report['label.scale']}"/>
                    </c:forEach>
                </p:row>  
            </p:columnGroup>  
            <!-- ROW ITEM-->
            <!-- Header columns (levels) -->
            <c:forEach begin="1" end="#{reportController.maxHeaderColumn}" varStatus="loop">
                <c:set var="headerText" value="#{item.headers[loop.index] ne null ? item.headers[loop.index] : report['label.total']}"/>-->
                <p:column>
                    <h:outputText value="#{headerText}"/>
                </p:column>
            </c:forEach>
            
            <!-- Month columns -->
            <c:forEach items="#{reportController.monthColumns}" var="month">
                <p:column>
                    <h:outputText style="right" value="#{not empty item.data[month].current ? item.data[month].current : 0}"/>
                </p:column>
                <p:column>
                    <h:outputText style="right" value="#{not empty item.data[month].last ? item.data[month].last : 0}"/>
                </p:column>
                <p:column>
                    <h:outputText style="right" value="#{not empty item.data[month].percent ? item.data[month].percent : '-'}"/>
                </p:column>
            </c:forEach>

            <p:column>
                <h:outputText style="right" value="#{item.current}"/>
            </p:column>
            <p:column>
                <h:outputText style="right" value="#{item.last}"/>
            </p:column>
            <p:column>
                <h:outputText style="right" value="#{item.percent}"/>
            </p:column>
            <!-- END ROW ITEM -->
            <p:columnGroup type="footer">
                <p:row>
                    <p:column colspan="#{reportController.maxHeaderColumn}" footerText="#{report['label.total']}"/>  
                    <c:forEach items="#{reportController.monthColumns}" var="month">
                        <p:column footerText="#{empty reportController.report.data[month].current ? '0' : reportController.report.data[month].current}"/>
                        <p:column footerText="#{empty reportController.report.data[month].last ? '0' : reportController.report.data[month].last}"/>
                        <p:column footerText="#{empty reportController.report.data[month].percent ? '-' : reportController.report.data[month].percent}"/>
                    </c:forEach>
                    <p:column footerText="#{empty reportController.report.current ? '0' : reportController.report.current}"/>
                    <p:column footerText="#{empty reportController.report.last ? '0' : reportController.report.last}"/>
                    <p:column footerText="#{empty reportController.report.percent ? '-' : reportController.report.percent }"/>
                </p:row>
            </p:columnGroup>
        </p:dataTable>
        <p:outputPanel id="reportChart">
            <p:outputPanel style="${reportController.displayReportFlag ? '' : 'height:0; overflow:hidden'}">
                <div class="row">
                    <div class="col-md-12">
                        <div class="box box-info no-resize">
                            <div class="box-header with-border">
                                <h3 class="box-title">#{report['label.calc.current.month']}</h3>

<!--                                <div class="box-tools">
                                    <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
                                    </button>
                                </div>-->
                            </div>
                            <div class="box-body">
                                <div class="chart">
                                    <canvas id="lineChart" style="height: 230px;" height="230"></canvas>
                                </div>
                            </div>
                            <!-- /.box-body -->
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="box box-danger no-resize">
                            <div class="box-header with-border">
                                <h3 class="box-title">#{report['label.calc.current.month2']}</h3>

<!--                                <div class="box-tools pull-right">
                                    <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
                                    </button>
                                </div>-->
                            </div>
                            <p:outputPanel styleClass="box-body" rendered="#{not empty reportController.pieChartData.getValues()}">
                                <canvas id="pieChart" style="height: 230px;" height="230"></canvas>
                            </p:outputPanel>
                            <p:outputPanel styleClass="box-body" style="height: 250px" rendered="#{empty reportController.pieChartData.getValues()}">
                                <p class="text-danger">#{report['label.nodata']}#{msg['symbol.ideographicperiod']}</p>
                            </p:outputPanel>
                            <!-- /.box-body -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="box box-success no-resize">
                            <div class="box-header with-border">
                                <h3 class="box-title">#{report['label.calc.current.year']}</h3>

<!--                                <div class="box-tools pull-right">
                                    <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
                                    </button>
                                </div>-->
                            </div>
                            <div class="box-body">
                                <div class="chart">
                                    <canvas id="barChart" style="height: 230px;" height="230"></canvas>
                                </div>
                            </div>
                            <!-- /.box-body -->
                        </div>
                    </div>
                </div>
            </p:outputPanel>
        </p:outputPanel>
        <p:outputPanel id="reportScriptChart">
            <h:outputScript library="js" name="rcolor.js"/>
            <h:outputScript library="plugins" name="chartjs/Chart.min.js"/>
            <script type="text/javascript">
                //<![CDATA[
                function saveChartImage(){
                    var lineChartData = document.getElementById("lineChart").toDataURL();
                    var pieChartData = '';
                    try{
                        pieChartData = document.getElementById("pieChart").toDataURL();
                    }catch(e){}
                    var barChartData = document.getElementById("barChart").toDataURL();
                    
                    cmdSaveChartImage([
                        {name:'line', value: lineChartData}, 
                        {name:'pie', value: pieChartData}, 
                        {name:'bar', value: barChartData}
                    ]);
                }
                
                function doExport(){
                    startProcessExport();
                    cmdExport();
                }
                //]]>
            </script>
            <script type="text/javascript">
                //-------------
                //- LINE CHART -
                //--------------
                var lineChartData = {
                    labels: #{reportController.lineChartData.getMonths()},
                    datasets: []
                };
                var colorFactory = new RColor;
                var baseColor;
                <c:forEach var="p" items="#{reportController.lineChartData.getProducts()}">
                baseColor = colorFactory.get(true, 0.6, 0.99);
                lineChartData.datasets.push({
                        label: "#{reportController.lineChartData.getLabel(p)}",
                        backgroundColor: baseColor,
                        borderColor: baseColor,
                        pointBackgroundColor: baseColor,
                        pointBorderColor: "#c1c7d1",
                        pointHoverBackgroundColor: "#fff",
                        pointHoverBorderColor: "#dcdcdc",
                        fill: false,
                        lineTension: 0.1,
                        borderCapStyle: 'butt',
                        borderDash: [],
                        borderDashOffset: 0.0,
                        borderJoinStyle: 'miter',
                        pointBorderWidth: 1,
                        pointHoverRadius: 5,
                        pointHoverBorderWidth: 2,
                        pointRadius: 1,
                        pointHitRadius: 10,
                        spanGaps: true,
                        data: #{reportController.lineChartData.getValues(p)}
                            });
                            </c:forEach>

                var pieChartData = {
                    labels: #{reportController.pieChartData.getLabels()},
                    datasets: [
                        {
                            data: #{empty reportController.pieChartData.getValues() ? '[]' : reportController.pieChartData.getValues()},
                            backgroundColor: []
                        }]
                };
                <c:forEach var="p" items="#{reportController.pieChartData.entrySet()}">
                    pieChartData.datasets[0].backgroundColor.push(colorFactory.get(true, 0.3, 0.99));
                </c:forEach>

                var barChartData = {
                    labels: #{reportController.barChartData.getLabels()},
                    datasets: [
                        {
                            label: "#{report['label.prev.year']}",
                            backgroundColor: "rgba(255, 206, 86, .9)",
                            borderColor: "rgb(255, 206, 86)",
                            borderWidth: 1,
                            data: #{reportController.barChartData.getLastValues()}
                        },
                        {
                            label: "#{report['label.current.year']}",
                            backgroundColor: "rgba(60,141,188,0.9)",
                            borderColor: "rgba(60,141,188,0.8)",
                            borderWidth: 1,
                            data: #{reportController.barChartData.getCurrentValues()}
                        }
                    ]};
            </script>
            <h:outputScript library="js" name="report.js"/>
        </p:outputPanel>
    </h:form>
</ui:composition>
