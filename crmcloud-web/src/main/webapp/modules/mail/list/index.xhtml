<?xml version='1.0' encoding='UTF-8' ?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
    <h:form id="mailingListForm" prependId="false" style="margin-left: -10px">
        <h:panelGrid width="100%" styleClass="page-header" style="font-size: 1.1em !important;">
            <f:facet name="header">
                <table style="width: 100%; margin-top: -9px;">
                    <td style="width: 220px; vertical-align: top;">
                        <ul class="sidebar-menu">
                            <li class="header" id="mail-fixed-folders-header">
                                <i class="fa fa-list" aria-hidden="true"></i>  #{mailBundle['label.mail.folder.list.fixed']}
                            </li>
                        </ul>
                    </td>
                    <td style="vertical-align: top;">
                        <p:outputPanel id="emailDetailToolPanel" styleClass="col-md-10 form-inline" style="margin-top: 5px; width: 100%">
                            <h:outputText styleClass="h3 no-margin" value="#{mailFolderController.currentFolderName}" rendered="${not mailListController.displayDetailToolPanel}"/>
                            <p:outputPanel styleClass="pull-left" rendered="${mailListController.displayDetailToolPanel}">
                                <p:commandButton value="#{msg['label.back']}" title="#{mailBundle['label.back.to.list']}" icon="fa fa-arrow-left"
                                                 actionListener="#{mailController.goBackFromDetailToList()}" update="mainContent"
                                                 onstart="start()" onsuccess="finish()">
                                    <p:confirm header="#{msg['label.confirm']}" message="#{msg['label.message.confirm.back']}" icon="ui-icon-alert"/>
                                </p:commandButton>
                                <p:selectOneMenu widgetVar="selCofirmMoveToFolder" effect="fade" onchange="PF('cofirmMoveToFolder').show();"
                                                 value="#{mailListController.folderToChange}" style="vertical-align: bottom; width: 60px;" filter="true" filterMatchMode="startsWith">
                                    <p:ajax listener="#{mailListController.moveMailToFolder}">
                                        <f:param name="actionMoveToFolder" value=""/>
                                    </p:ajax>
                                    <f:selectItem itemLabel="" itemValue="" />
                                    <f:selectItems value="#{mailFolderController.allFolders}"
                                                   var="folder"
                                                   itemLabel="#{folder.displayFolderNameWithIcon}"
                                                   itemValue="#{folder.folderCode}">
                                    </f:selectItems>
                                </p:selectOneMenu>
                                <p:commandButton value="#{msg['label.delete']}" title="#{msg['label.delete']}" icon="fa fa-trash"
                                                 actionListener="#{mailListController.delete}" update="mainContent"
                                                 onstart="start()" onsuccess="finish()">
                                    <p:confirm header="#{msg['label.confirm']}" message="#{msg['label.confirm.delete']}" icon="ui-icon-alert" />
                                </p:commandButton>
                                <div class="btn-group">
                                    <!--<p:commandLink value="#{mailBundle['label.split.mail']}" title="#{mailBundle['label.split.mail']}" styleClass="btn btn-default btn-sm"> <i class="fa fa-filter"></i> </p:commandLink>-->
<!--                                    <h:commandLink value="#{mailBundle['label.mail.issue.create']}" title="#{mailBundle['label.mail.issue.create']}"
                                                   rendered="#{empty mailController.mailDataModel.mailData.issue}" styleClass="btn btn-default btn-sm"
                                                   action="#{mail2IssueController.processExplodeMail(mailController.mailDataModel.mailData.mailDataId)}" target="_blank" />-->
                                    <h:commandLink value="#{mailBundle['label.mail.issue.create']}" title="#{mailBundle['label.mail.issue.create']}" 
                                                   styleClass="btn btn-default btn-sm"
                                                   rendered="#{empty mailController.mailDataModel.mailData.issue}"
                                                   actionListener="#{mail2IssueController.processExplodeMail(mailController.mailDataModel.mailData.mailDataId)}" 
                                                   action="#{issueController.outcome(-1)}"
                                                   target="_blank" >
                                        <f:param name="id" value="-1"/>
                                        <f:param name="force" value="true"/>
                                    </h:commandLink>
                                </div>
                                <p:selectOneMenu style="vertical-align: bottom; width:60px" value="#{mailController.mailPersonId}"
                                                 onchange="PF('cofirmPersonChange').show();" filter="true" filterMatchMode="startsWith">
                                    <p:ajax listener="#{mailController.onPersonChange}"/>
                                    <f:selectItem itemLabel="" itemValue="" />
                                    <f:selectItems value="#{mailController.mailPersons}" var="person" itemValue="#{person.mailPersonId}" itemLabel="#{person.mailPersonInCharge.memberNameFirst}"/>
                                </p:selectOneMenu>
                            </p:outputPanel>
                            <div class="pull-right" style="margin-right: -25px;">
                                <p:commandButton value="#{mailBundle['label.person.in.charge']}" icon="fa fa-users" oncomplete="PF('mailPersonDialog').show();" actionListener="#{mailPersonController.init()}" update="mailPersonDialog"
                                                 onstart="start()" onsuccess="finish()"/>
                                <p:commandButton value="#{mailBundle['label.reload']}" icon="fa fa-refresh"
                                                 actionListener="#{mailListController.onRefresh(true)}"
                                                 update="mainContent" onstart="start()" onsuccess="finish()"/>
                                <p:inputText styleClass="txt-search-with-key form-control input-sm inline-block" style="width: 120px;" value="#{mailListController.searchKey}" maxlength="100"/>
                                <p:commandButton value="#{mailBundle['label.search']}" icon="fa fa-search " styleClass="txt-search-with-key-action"
                                                 actionListener="#{mailListController.searchWithKey}"
                                                 update="@form" onstart="start()" onsuccess="finish()"/>
                                <!--<p:commandButton value="#{mailBundle['label.detail.search']}" icon="fa fa-search-plus"/>--> <!-- tam thoi comment do chua su dung den -->
                            </div>
                        </p:outputPanel>
                    </td>
                </table>
            </f:facet>
        </h:panelGrid>
        <table style="width: 100%; margin-top: -7px;">
            <tr>
                <td style="width: 220px;vertical-align: top;">
                    <ul class="sidebar-menu" id="sidebar-menu" style="padding-left: 0px; top: -45px; font-size: 1.1em !important;">
                        <div class="ui-outputpanel ui-widget sidebar-menu cf" id="mail-fixed-folders-content">
                            <li class="treeview active">
                                <ul class="treeview-menu menu-open" style="height: 140px;">
                                    <c:forEach items="#{mailFolderController.fixedFolders}" var="folder">
                                        <li class="#{folder.selected?'side-bar-active':''}">
                                            <p:commandLink actionListener="#{mailListController.gotoListMail(folder.folderCode)}" update="@form" onstart="start()" onsuccess="finish()">
                                                <i class="#{folder.icon}"></i>
                                                <h:outputText style="font-weight: #{folder.selected?'bolder':''};margin-left:5px;" value="#{folder.mailFolder.mailFolderName}"/>
                                                <small class="label pull-right label-primary project-item-count" style="right: 3px;">#{folder.total}</small>
                                            </p:commandLink>
                                        </li>
                                    </c:forEach>
                                </ul>
                            </li>
                        </div>
                        <li class="header" id="mail-dynamic-folders-header">
                            <table style="width: 100%;">
                                <tr>
                                    <td style="font-weight: bold">
                                        <i class="fa fa-list" aria-hidden="true"></i>  #{mailBundle['label.mail.folder.list.dynamic']}
                                    </td>
                                    <td>
                                        <div class="btn-group" style="float: right;">
                                            <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                                                <i class="caret"></i>
                                            </button>
                                            <ul class="dropdown-menu" role="menu">
                                                <li>
                                                    <p:commandLink value="#{mailBundle['label.create.folder']}" oncomplete="PF('createMailFolder').show();"
                                                                   actionListener="#{mailFolderController.onChangeMailFolder}"
                                                                   rendered="${sec.hasMethod('mailFolderController', 'create')}"
                                                                   update="createMailFolder" process="@this">
                                                        <f:param name="mailFolderId" value=""/>
                                                    </p:commandLink>
                                                </li>                               
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </li>
                        <div class="ui-outputpanel ui-widget sidebar-menu cf" id="mail-dynamic-folders-content">
                            <li class="treeview active">
                                <ul class="treeview-menu menu-open" id="mail-dynamic-folders-items">
                                    <c:forEach items="#{mailFolderController.dynamicFolders}" var="folder">
                                        <li class="#{folder.selected?'side-bar-active':''}">
                                            <p:commandLink rendered="#{sec.hasMethod('MailFolderController','view')}"
                                                           actionListener="#{mailListController.gotoListMail(folder.folderCode)}" 
                                                           update="@form" onstart="start()" onsuccess="finish()">
                                                <i class="#{folder.icon}"></i>
                                                <h:outputText style="font-weight: #{folder.selected?'bolder':''};margin-left:5px;" value="#{folder.mailFolder.mailFolderName}"/>
                                            </p:commandLink>
                                            <div class="btn-group mail-dynamic-folders-item" style="float: right; top: -25px;">
                                                <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                                                    <i class="caret"></i>
                                                </button>
                                                <ul class="dropdown-menu" role="menu">
                                                    <li>
                                                        <p:commandLink value="#{mailBundle['label.change.name']}" oncomplete="PF('updateMailFolder').show();"
                                                                       actionListener="#{mailFolderController.onChangeMailFolder}" update="updateMailFolder" process="@this"
                                                                       rendered="#{sec.hasMethod('MailFolderController','update')}">
                                                            <f:param name="mailFolderId" value="#{folder.mailFolder.mailFolderId}"/>
                                                        </p:commandLink>
                                                    </li>
                                                    <li>
                                                        <p:commandLink value="#{msg['label.delete']}"
                                                                       update="mainContent,:growl" actionListener="#{mailFolderController.delete}" onstart="start()" onsuccess="finish()"
                                                                       rendered="#{sec.hasMethod('MailFolderController','delete')}">
                                                            <f:param name="mailFolderId" value="#{folder.mailFolder.mailFolderId}"/>
                                                            <p:confirm header="#{msg['label.confirm']}" message="#{msg['label.confirm.delete']}" icon="ui-icon-alert" />
                                                        </p:commandLink>
                                                    </li>
                                                </ul>
                                            </div>
                                        </li>
                                    </c:forEach>
                                </ul>
                            </li>
                        </div>
                    </ul>
                </td>
                <td style="vertical-align: top;">
                    <p:outputPanel id="mailContentPanel" style="padding-left: 1px; padding-right: 1px; width: 101%;">
                        <ui:include src="#{mailListController.sectionContent}" />
                        <h:outputScript>
                            $(document).ready(function(){
                                $(function() {
                                    $.fn.smoothElements();
                                });
                            });
                        </h:outputScript>
                    </p:outputPanel>
                </td>
            </tr>
        </table>
        <script type="text/javascript">
            jQuery(document).ready(function ($) {
                $(".txt-search-with-key").keypress(function (event) {
                    if (event.which === 13) {
                        $(".txt-search-with-key-action").trigger('click');
                        event.preventDefault();
                    }
                });

                /**
                 * Fix Dropdown menu, how to append dropdown menu to body element
                 * @author hungpham
                 * @returns {undefined}
                 */
                // and when you show it, move it to the body                                     
                $("#mailingListForm .dropdown-menu").parent().each(function () {
                    // hold onto the drop down menu                                             
                    var dropdownMenu;

                    $(this).on('show.bs.dropdown', function (e) {

                        // grab the menu        
                        dropdownMenu = $(e.target).find('.dropdown-menu');

                        // detach it and append it to the body
                        $('body').append(dropdownMenu.detach());

                        // grab the new offset position
                        var eOffset = $(e.target).offset();

                        // make sure to place it where it would normally go (this could be improved)
                        dropdownMenu.css({
                            'display': 'block',
                            'top': eOffset.top + $(e.target).outerHeight(),
                            'left': eOffset.left
                        });
                    })
                            // and when you hide it, reattach the drop down, and hide it normally                                                   
                            .on('hide.bs.dropdown', function (e) {
                                $(e.target).append(dropdownMenu.detach());
                                dropdownMenu.hide();
                            });
                });
            });
            function closeMoveFolderDlg() {
                try { PF('selCofirmMoveToFolder').selectValue(''); } catch(e) {}
                try { PF('selCofirmMoveToFolder01').selectValue(''); } catch(e) {}
                try { PF('selCofirmMoveToFolder02').selectValue(''); } catch(e) {}
                PF('cofirmMoveToFolder').hide();
            }
        </script>
    </h:form>
    <p:dialog id="mailPersonDialog" widgetVar="mailPersonDialog" width="1000" height="460" modal="true" dynamic="true" responsive="true" resizable="false" appendTo="@(body)" position="top" style="margin-top: 26px;">
        <ui:include src="/modules/mail/person/index.xhtml"/>
    </p:dialog>
    <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
        <p:commandButton value="#{msg['label.yes']}" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
        <p:commandButton value="#{msg['label.no']}" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
    </p:confirmDialog>
    <p:confirmDialog message="#{mailBundle['label.confirm']}" header="#{msg['label.confirm']}"  widgetVar="cofirmMoveToFolder">  
        <p:commandButton value="#{msg['label.yes']}" oncomplete="closeMoveFolderDlg();" icon="ui-icon-check"
                         update="mainContent" process="@this" actionListener="#{mailListController.moveMailToFolder}">
            <f:param name="actionMoveToFolder" value="1"/>
        </p:commandButton>
        <p:commandButton value="#{msg['label.no']}" oncomplete="closeMoveFolderDlg();" icon="ui-icon-close">
            <f:param name="actionMoveToFolder" value="0"/>
        </p:commandButton>
    </p:confirmDialog>
    <p:confirmDialog message="#{mailBundle['label.mail.person.change.message']}" header="#{mailBundle['label.mail.person.change.header']}"  widgetVar="cofirmPersonChange">  
        <p:commandButton value="#{msg['label.yes']}" onclick="PF('cofirmPersonChange').hide();" icon="ui-icon-check"
                         update="mainContent :growl" process="@this"
                         actionListener="#{mailController.onPersonChange}">
            <f:param name="store" value="1"/>
        </p:commandButton>
        <p:commandButton value="#{msg['label.no']}" onclick="PF('cofirmPersonChange').hide();" icon="ui-icon-close"
                         update="mainContent" process="@this"
                         actionListener="#{mailController.onPersonChange}">
            <f:param name="store" value="0"/>
        </p:commandButton>
    </p:confirmDialog>
    <p:dialog header="#{mailBundle['label.change.folder.name']}" widgetVar="updateMailFolder" resizable="false" modal="true" dynamic="true" responsive="true" showEffect="fade" hideEffect="fade" id="updateMailFolder">
        <h:form id="updateMailFolderFrm" style="z-index: 0">
            <p><h:outputLabel value="#{mailBundle['label.input.folder.name']}"/></p>
            <p:inputText value="#{mailFolderController.folderModel.mailFolder.mailFolderName}" maxlength="100" style="width: 100%">
                <f:validator validatorId="gnext.validator.RequiredValidator" />
                <f:validator validatorId="gnext.validator.LengthValidator" />
                <f:attribute name="max" value="100"/>
                <f:attribute name="title" value="#{mailBundle['label.change.folder.name']}"/>
            </p:inputText>
            <p:remoteCommand name="updateMailFolderCommand" actionListener="#{mailFolderController.update}" update="updateMailFolderFrm :growl" process="@form" />
        </h:form>
        <f:facet name="footer">
            <p:outputPanel styleClass="text-right" style="overflow: hidden">
                <p:commandButton value="#{msg['label.yes']}" onclick="updateMailFolderCommand()" icon="ui-icon-check"/>
                <p:spacer width="5"></p:spacer>
                <p:commandButton value="#{msg['label.no']}" onclick="PF('updateMailFolder').hide();" icon="ui-icon-close"/>
            </p:outputPanel>  
        </f:facet>
    </p:dialog>
    <p:dialog header="#{mailBundle['label.change.folder.name']}" widgetVar="createMailFolder" resizable="false" modal="true" dynamic="true" responsive="true" showEffect="fade" hideEffect="fade" id="createMailFolder">
        <h:form id="createMailFolderFrm">
            <p><h:outputLabel value="#{mailBundle['label.input.folder.name']}"/></p>
            <p:inputText value="#{mailFolderController.folderModel.mailFolder.mailFolderName}" maxlength="100" style="width: 100%">
                <f:validator validatorId="gnext.validator.RequiredValidator" />
                <f:validator validatorId="gnext.validator.LengthValidator" />
                <f:attribute name="max" value="100"/>
                <f:attribute name="title" value="#{mailBundle['label.input.folder.name']}"/>
            </p:inputText>
            <p:remoteCommand name="createMailFolderCommand" actionListener="#{mailFolderController.create}" update="createMailFolderFrm :growl" process="@form" />
        </h:form>
        <f:facet name="footer">
            <p:outputPanel styleClass="text-right" style="overflow: hidden">
                <p:commandButton value="#{msg['label.yes']}" onclick="createMailFolderCommand()" icon="ui-icon-check"/>
                <p:spacer width="5"></p:spacer>
                <p:commandButton value="#{msg['label.no']}" onclick="PF('createMailFolder').hide();" icon="ui-icon-close"/>
            </p:outputPanel>
        </f:facet>
    </p:dialog>
</ui:composition>