<?xml version='1.0' encoding='UTF-8' ?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:pe="http://primefaces.org/ui/extensions"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
    <div id="pageTitle">#{mailController.mailDataModel.mailData.mailDataSubject} - #{msg['label.menu.MAIL']}</div>
    <div class="box box-primary">
        <div class="box-header">
            <h4 class="no-margin">#{mailController.mailDataModel.mailData.mailDataSubject}</h4>
            
            <div class="box-tools pull-right">
                <h:outputText style="display: inline;" value="#{mailController.paginator.to} / #{mailController.paginator.total}"/>
                <p:spacer width="10"/>
                <p:commandLink title="#{msg['label.previous']}" styleClass="btn btn-box-tool" id="btnNext" disabled="#{mailController.paginator.first}"
                               actionListener="#{mailController.previousPaging}" update=":mailingListForm:mailContentPanel"
                               onstart="start()" onsuccess="finish()">
                    <f:param name="page" value="details"/>
                    <i class="fa fa-chevron-left"></i>
                </p:commandLink>
                <p:commandLink title="#{msg['label.next']}" styleClass="btn btn-box-tool" id="btnPrevious" disabled="#{mailController.paginator.last}"
                               actionListener="#{mailController.nextPaging}" update=":mailingListForm:mailContentPanel"
                               onstart="start()" onsuccess="finish()">
                    <f:param name="page" value="details"/>
                    <i class="fa fa-chevron-right"></i>
                </p:commandLink>
            </div>
        </div>
        <div class="box-body no-padding">
            <div class="row">
                <div class="col-md-9 no-padding-right">
                    <div class="mailbox-read-info">
                        <h5>
                            <label>#{mailController.mailDataModel.mailData.mailDataFrom}</label> <br/>
                            <small>to: #{mailController.mailDataModel.mailData.mailDataTo}</small> <br/>
                            <c:if test="#{not empty mailController.mailDataModel.attachments and mailController.mailDataModel.attachments.size() > 0}">
                                <c:forEach var="attachment" items="#{mailController.mailDataModel.attachments}">
                                    <small>
                                        <i class="fa fa-file-archive-o" aria-hidden="true"></i>
                                        <p:commandLink ajax="false" value="#{mailController.viewAttachmentName(attachment.attachmentName)}" style="margin-left: 5px;"
                                                       actionListener="#{downloadController.prepDownloadAttachment(attachment.attachmentId)}"
                                                       onstart="start()" onsuccess="finish()"> 
                                            <p:fileDownload value="#{downloadController.fileDownload}" />
                                        </p:commandLink>
                                    </small>
                                </c:forEach>
                            </c:if>
                            <span class="mailbox-read-time pull-right">
                                <h:outputText value="#{mailController.mailDataModel.mailData.mailDataDatetime}">
                                    <f:converter converterId="org.ocpsoft.PrettyTimeConverter"/>
                                </h:outputText>
                                (<h:outputText value="#{mailController.mailDataModel.displaySentDate}" />)
                            </span>
                        </h5>
                    </div>
                    <div class="mailbox-read-message" id="mailbox_read_message" style="overflow: auto;">
                        <h:outputText escape="false" value="#{mailController.mailDataModel.body}" style="white-space: pre-wrap;"/>
                    </div>
                    <!-- /.mailbox-read-message -->
                </div>

                <div class="col-md-3">
                    <div class="panel panel-default" id="projectHistory">
                        <div class="panel-heading">#{mailBundle['label.mail.details.escalation.header']}</div>
                        <div class="panel-body" style="overflow: auto" id="mail_issue_relation">
                            <c:if test="#{mailController.mailDataModel.hasIssueRelated()}">
                                <c:forEach var="ir" items="#{mailController.mailDataModel.issueRelated}">
                                    <table style="width: 100%;">
                                        <tr>
                                            <td>
                                                <h:outputText value="#{ir.issueReceiveDate}">
                                                    <f:convertDateTime type="date" pattern="yyyy-MM-dd"/>
                                                </h:outputText>
                                            </td>
                                            <td>
                                                #{ir.issueReceivePerson.memberNameFirst}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <p:commandLink value="#{mailBundle['label.project.link']}" title="#{mailBundle['label.project.link']}" styleClass="btn btn-default btn-sm" onstart="start()" onsuccess="finish()"
                                                               actionListener="#{mailController.checkoutIssue(ir.issueId)}" update="mainContent :growl"/>
                                            </td>
                                            <td>
                                                <h:commandLink 
                                                    target="_blank"
                                                    actionListener="#{issueController.show()}"
                                                    action="#{issueController.outcome(ir.issueId)}"
                                                    disabled="#{not (sec.isMaster() or sec.hasMethod('IssueController', 'view'))}"
                                                    title="#{ir.issueViewCode}" value="#{ir.issueViewCode}" style="font-weight: bold; color: blue;">
                                                    <f:param name="id" value="#{ir.issueId}" />
                                                    <f:param name="force" value="true"/>
                                                </h:commandLink>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="2">
                                                #{ir.issueContentAsk}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="2">
                                                <hr/>
                                            </td>
                                        </tr>
                                    </table>
                                </c:forEach>
                            </c:if>
                            <c:if test="#{not mailController.mailDataModel.hasIssueRelated()}">
                                <h6 class="text-warning text-center"><i>#{mailBundle['label.nodata']}</i></h6>
                            </c:if>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</ui:composition>