<?xml version='1.0' encoding='UTF-8' ?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
    <style>
        .col-vertical-align-top td { vertical-align: top; }
        .col-vertical-align-top td:nth-child(1) { width: 300px; }
        .col-vertical-align-bottom td:nth-child(1) { width: 20px; }
        .ui-widget-content{ border: 0px solid #d5d5d5; background: #fff; color: #222; }
        .row-selected { background-color: #fca752 !important; }
        .ui-panel-titlebar { padding: 4px 10px !important; }
    </style>
    <div id="pageTitle">#{mailBundle['label.mail.filter.title']} #{msg['symbol.paren.left']}#{mailBundle['label.mail.filter.title.configuration']}#{msg['symbol.paren.right']}</div>
    <h:form id="fromMailFilter">
        <h:panelGrid width="100%" styleClass="page-header" id="pngHeader">
            <f:facet name="header">
                <div class="row">
                    <div class="col-md-6">
                        <h1>
                            #{mailBundle['label.mail.filter.title']}<small>#{mailBundle['label.mail.filter.title.configuration']}</small>
                        </h1>
                    </div>
                    <div class="col-md-6 text-right">
                        <p:commandButton value="#{msg['label.create']}"
                                         icon="fa fa-plus-circle"
                                         title="#{msg['label.create']}"
                                         actionListener="#{mailFilterController.show}"
                                         update="mainContent"
                                         rendered="#{mailFilterController.showTipPage()}"
                                         onstart="start()" onsuccess="finish()">
                            <f:param name="showType" value="create"/>
                        </p:commandButton>
                        <p:commandButton value="#{msg['label.back']}"
                                         title="#{msg['label.back']}"
                                         icon="fa fa-chevron-circle-left"
                                         update="mainContent" process="@this"
                                         actionListener="#{mailFilterController.load()}"
                                         rendered="#{mailFilterController.showBackButton()}"
                                         onstart="start()" onsuccess="finish()">
                        </p:commandButton>
                        <p:commandButton value="#{msg['label.save']}"
                                         title="#{msg['label.save']}"
                                         icon="fa fa-check-circle"
                                         update="mainContent,:growl"
                                         rendered="#{mailFilterController.showAddPage() and sec.hasMethod('MailFilterController', 'create')}"
                                         onstart="start()" onsuccess="finish()"
                                         type="button" styleClass="btn-add">
                        </p:commandButton>
                        <p:commandButton value="#{msg['label.edit']}"
                                         title="#{msg['label.edit']}"
                                         icon="fa fa-check-circle"
                                         update="mainContent,:growl"
                                         rendered="#{mailFilterController.showEditPage() and sec.hasMethod('MailFilterController', 'update')}"
                                         onstart="start()" onsuccess="finish()"
                                         type="button" styleClass="btn-update">
                        </p:commandButton>
                    </div>
                </div>
            </f:facet>
        </h:panelGrid>
        <div class="box">
            <div class="box-body" style="overflow-y: auto">
                <table class="grid-wrapper col-vertical-align-top" style="width: 100%;margin-top: -10px;">
                    <tr>
                        <!-- ///////////////////////////////MENU BÊN TRÁI. -->
                        <td>
                            <p:dataGrid var="row" columns="1" id="listFilters" value="#{mailFilterController.models}" emptyMessage="#{msg['label.records.empty']}">
                                <f:facet name="header">
                                    <p:outputLabel value="#{mailBundle['label.mail.filter.priority']}"/>
                                </f:facet>
                                <table class="#{not empty mailFilterController.activeMenu(row.mailFilter.mailFilterId)?'row-selected':''} tblItemsFilters"
                                       style="margin-left: -3px;margin-right: -3px;margin-bottom: -3px;margin-top: -3px;cursor: pointer;">
                                    <tr style="border-bottom: 1px solid #d2d6de;">
                                        <!-- hiển thị tên FILTER. -->
                                        <td style="padding-top: 4px;padding-left: 10px;"
                                            class="#{row.mailFilter.mailFilterId eq mailFilterController.model.mailFilter.mailFilterId?'itemactive':''}">
                                            <p:commandLink value="#{stringController.substring(row.mailFilter.mailFilterTitle, 10)}"
                                                           actionListener="#{mailFilterController.show}"
                                                           style="display:block; font-weight: #{mailFilterController.activeMenu(row.mailFilter.mailFilterId)}"
                                                           process="@this"  onstart="start()" onsuccess="finish()"
                                                           update="fromMailFilter:pngHeader,fromMailFilter:rightPanel,listFilters,mainContent">
                                                <f:param name="mailFilterId" value="#{row.mailFilter.mailFilterId}"/>
                                                <f:param name="showType" value="edit"/>
                                                <p:resetInput target="@form" />
                                            </p:commandLink>
                                        </td>
                                        <!-- menu action cho việc up, dơwn, last, first các FILTER. -->
                                        <td>
                                            <div  class="dropdown" style="float: right;">
                                                <button style="width: 25px; height: 25px;"
                                                        class="btn btn-default dropdown-toggle" type="button"
                                                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                                    <span class="caret" style="margin-left: -4px;margin-top: -9px;"></span>
                                                </button>
                                                <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                                                    <li>
                                                        <p:commandLink value="#{mailBundle['label.mail.filter.edit']}"
                                                                       actionListener="#{mailFilterController.show}"
                                                                       process="@this"
                                                                       rendered="#{sec.hasMethod('MailFilterController', 'update')}"
                                                                       update="fromMailFilter:pngHeader,fromMailFilter:rightPanel,listFilters,mainContent"
                                                                       onstart="start()" onsuccess="finish()">
                                                            <f:param name="mailFilterId" value="#{row.mailFilter.mailFilterId}"/>
                                                            <f:param name="showType" value="edit"/>
                                                            <p:resetInput target="@form" />
                                                        </p:commandLink>
                                                    </li>
                                                    <li>
                                                        <p:commandLink value="#{mailBundle['label.mail.filter.copy']}"
                                                                       actionListener="#{mailFilterController.copy}"
                                                                       process="@this"
                                                                       update="fromMailFilter:pngHeader,fromMailFilter:rightPanel,listFilters,mainContent"
                                                                       onstart="start()" onsuccess="finish()"
                                                                       rendered="#{sec.hasMethod('MailFilterController', 'copy')}">
                                                            <f:param name="mailFilterId" value="#{row.mailFilter.mailFilterId}"/>
                                                            <p:resetInput target="@form" />
                                                        </p:commandLink>
                                                    </li>
                                                    <li>
                                                        <p:commandLink value="#{mailBundle['label.mail.filter.delete']}"
                                                                       actionListener="#{mailFilterController.delete}"
                                                                       process="@this" update="mainContent, :growl"
                                                                       rendered="#{sec.hasMethod('MailFilterController', 'delete')}"
                                                                       onstart="start()" onsuccess="finish()">
                                                            <f:param name="mailFilterId" value="#{row.mailFilter.mailFilterId}"/>
                                                            <p:confirm header="#{mailBundle['label.mail.filter.delete.header']}" message="#{mailBundle['label.mail.filter.delete.confirm']}" icon="ui-icon-alert" />
                                                            <p:resetInput target="@form" />
                                                        </p:commandLink>
                                                    </li>
                                                    <li>
                                                        <p:commandLink value="#{mailBundle['label.mail.filter.priority.high']}"
                                                                       actionListener="#{mailFilterController.up}"
                                                                       process="@this" update="listFilters"
                                                                       onstart="start()" onsuccess="finish()">
                                                            <f:param name="rowIndex" value="#{row.rowNum}"/>
                                                            <p:resetInput target="@form" />
                                                        </p:commandLink>
                                                    </li>
                                                    <li>
                                                        <p:commandLink value="#{mailBundle['label.mail.filter.priority.highest']}"
                                                                       actionListener="#{mailFilterController.first}"
                                                                       process="@this" update="listFilters"
                                                                       onstart="start()" onsuccess="finish()">
                                                            <f:param name="rowIndex" value="#{row.rowNum}"/>
                                                            <p:resetInput target="@form" />
                                                        </p:commandLink>
                                                    </li>
                                                    <li>
                                                        <p:commandLink value="#{mailBundle['label.mail.filter.priority.low']}"
                                                                       actionListener="#{mailFilterController.down}"
                                                                       process="@this" update="listFilters"
                                                                       onstart="start()" onsuccess="finish()">
                                                            <f:param name="rowIndex" value="#{row.rowNum}"/>
                                                            <p:resetInput target="@form" />
                                                        </p:commandLink>
                                                    </li>
                                                    <li>
                                                        <p:commandLink value="#{mailBundle['label.mail.filter.priority.lowest']}"
                                                                       actionListener="#{mailFilterController.last}"
                                                                       process="@this" update="listFilters"
                                                                       onstart="start()" onsuccess="finish()">
                                                            <f:param name="rowIndex" value="#{row.rowNum}"/>
                                                            <p:resetInput target="@form" />
                                                        </p:commandLink>
                                                    </li>
                                                </ul>
                                            </div> 
                                        </td>
                                    </tr>
                                </table>
                            </p:dataGrid>
                        </td>
                        <!-- ///////////////////////////////MENU BÊN PHẢI. -->
                        <td style="border: 1px solid #d5d5d5;">
                            <p:panel style="margin-bottom:20px" id="rightPanel">
                                <f:facet name="header">
                                    <p:outputLabel value="#{mailBundle['label.mail.filter.text.division']}" style="text-align: left; width: 100%;"/>
                                </f:facet>
                                <h:panelGrid columns="1" cellpadding="10" rendered="#{mailFilterController.showTipPage()}" style="width: 100%;" >
                                    <p:outputPanel>
                                        <h:outputText value="#{mailBundle['label.mail.filter.text']}" escape="false" />
                                    </p:outputPanel>
                                </h:panelGrid>
                                <h:panelGrid columns="1" cellpadding="10" style="width: 100%;" rendered="#{mailFilterController.showBackButton()}">
                                    <h:panelGrid columns="2" style="width: 35%;">
                                        <p:outputLabel value="#{mailBundle['label.mail.filter.name']}" styleClass="required"/>
                                        <p:inputText value="#{mailFilterController.model.mailFilter.mailFilterTitle}" id="j_mail_filter_title" maxlength="256">
                                            <f:validator validatorId="gnext.validator.RequiredValidator" />
                                            <f:validator validatorId="gnext.validator.LengthValidator" />
                                            <f:attribute name="max" value="256"/>
                                            <f:attribute name="title" value="#{mailBundle['label.mail.filter.name']}"/>
                                        </p:inputText>
                                    </h:panelGrid>
                                    <p:outputLabel value="#{mailBundle['label.mail.filter.message']}"/>
                                    <p:outputPanel>
                                        <div class="box box-solid box-search no-padding">
                                            <div class="box-header with-border" data-widget="collapse">
                                                <h3 class="box-title">#{msg['label.search.title']}</h3>
                                                ：<code></code>
                                                <div class="box-tools pull-right">
                                                    <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-plus"></i></button>
                                                </div>
                                            </div>
                                            <div class="box-body">
                                                <div id="search-filter"></div>
                                            </div>
                                        </div>
                                        <p></p>
                                        <div class="text-center">
                                            <h:inputText value="#{mailFilterController.searchDataJson}" styleClass="searchDataJson" style="display: none;"/>
                                            <p:commandLink actionListener="#{mailFilterController.save}"  style="display:none" styleClass="add-action"  onstart="start()" onsuccess="finish()"  update="mainContent, :growl"/>
                                            <p:commandLink actionListener="#{mailFilterController.update}"  style="display:none" styleClass="update-action"  onstart="start()" onsuccess="finish()"  update="mainContent, :growl"/>
                                        </div>
                                    </p:outputPanel>
                                    <p:outputLabel value="#{mailBundle['label.mail.filter.action.message']}"/>
                                    <!-- lựa chọn thư mục sẽ lưu mail message. -->
                                    <h:panelGrid  columns="2" style="width: 25%; margin-left: 5px;" styleClass=" col-vertical-align-bottom">
                                        <p:selectBooleanCheckbox value="#{mailFilterController.model.mailFilterMoveFolderFlag}">
                                            <p:ajax listener="#{mailFilterController.onMailFolderChange}" update="fromMailFilter:mailFolderDisplay" />
                                        </p:selectBooleanCheckbox>
                                        <p:outputLabel value="#{mailBundle['label.mail.filter.keep.message']}"/>
                                        <p:outputLabel value=""/>
                                        <p:outputPanel id="mailFolderDisplay">
                                            <h:panelGroup rendered="#{mailFilterController.displayMailFolderFlag}">
                                                <p:selectOneMenu value="#{mailFilterController.model.mailFilter.mailFilterMoveFolderCode}" id="mailFilter" style="width: 100%;" filter="true" filterMatchMode="startsWith">
                                                    <f:selectItem itemLabel="#{mailBundle['label.mail.filter.save']}" itemValue="" />
                                                    <f:selectItems value="#{mailFilterController.mailFolders}" var="mailFolder"  itemLabel="#{mailFolder.mailFolderName}" itemValue="#{mailFolder.mailFolderId}"/>
                                                </p:selectOneMenu>
                                            </h:panelGroup>
                                            <h:panelGroup rendered="#{!mailFilterController.displayMailFolderFlag}">
                                                <p:selectOneMenu value="#{mailFilterController.model.mailFilter.mailFilterMoveFolderCode}" id="mailFilterDisable" style="width: 100%;" filter="true" filterMatchMode="startsWith" disabled="true">
                                                    <f:selectItem itemLabel="#{mailBundle['label.mail.filter.save']}" itemValue="" />
                                                    <f:selectItems value="#{mailFilterController.mailFolders}" var="mailFolder"  itemLabel="#{mailFolder.mailFolderName}" itemValue="#{mailFolder.mailFolderId}"/>
                                                </p:selectOneMenu>
                                            </h:panelGroup>
                                        </p:outputPanel>
                                    </h:panelGrid>
                                    <!-- lựa chọn EXPLODE dùng để phân tách mail. -->
                                    <h:panelGrid  columns="2" style="width: 25%;margin-left: 5px;"  styleClass=" col-vertical-align-bottom">
                                        <p:selectBooleanCheckbox value="#{mailFilterController.model.mailFilterUseSettingExplodeFlag}">
                                            <p:ajax listener="#{mailFilterController.onMailExploderChange}" update="fromMailFilter:mailExplodeDisplay" />
                                        </p:selectBooleanCheckbox>
                                        <p:outputLabel value="#{mailBundle['label.mail.filter.explode']}"/>
                                        <p:outputLabel value=""/>
                                        <p:outputPanel id="mailExplodeDisplay">
                                            <h:panelGroup rendered="#{mailFilterController.displayMailExplodeFlag}">
                                                <p:selectOneMenu value="#{mailFilterController.model.mailFilter.mailFilterMailExplodeId}" id="mailExplode" style="width: 100%;" filter="true" filterMatchMode="startsWith"> 
                                                    <f:selectItem itemLabel="" itemValue="" />
                                                    <f:selectItems value="#{mailFilterController.mailExplodes}" var="mailExploder" itemLabel="#{mailExploder.mailExplodeTitle}" itemValue="#{mailExploder.mailExplodeId}"/>
                                                    <f:validator validatorId="gnext.validator.RequiredValidator" />
                                                    <f:attribute name="title" value="#{mailBundle['label.mail.filter.explode.title']}"/>
                                                </p:selectOneMenu>
                                            </h:panelGroup>
                                            <h:panelGroup rendered="#{!mailFilterController.displayMailExplodeFlag}">
                                                <p:selectOneMenu value="#{mailFilterController.model.mailFilter.mailFilterMailExplodeId}" id="mailExplodeDisable" filter="true" filterMatchMode="startsWith" style="width: 100%;" disabled="true">
                                                    <f:selectItem itemLabel="" itemValue="" />
                                                    <f:selectItems value="#{mailFilterController.mailExplodes}" var="mailExploder" itemLabel="#{mailExploder.mailExplodeTitle}" itemValue="#{mailExploder.mailExplodeId}"/>
                                                </p:selectOneMenu>
                                            </h:panelGroup>
                                        </p:outputPanel>
                                    </h:panelGrid>
                                </h:panelGrid>
                            </p:panel>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </h:form>
    <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
        <p:commandButton value="${msg['label.yes']}" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
        <p:commandButton value="${msg['label.no']}" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
    </p:confirmDialog>
    <h:outputScript library="js" name="search-filter.js"/>
    <h:outputScript>
        var searchFilterOpts = {
            hideOnEmpty: false,
            maxGroup: 2,
            fields: [
                {
                    "type": "string",
                    "label": "#{mailBundle['タイトル']}",
                    "name": 'filter_by_title',
                },
                {
                    "type": "string",
                    "label": "#{mailBundle['差出人']}",
                    "name": 'filter_by_mail_sender',
                },
                {
                    "type": "string",
                    "label": "Tên người gửi",
                    "name": 'filter_by_mail_sender_name',
                },
                {
                    "type": "string",
                    "label": "#{mailBundle['本文']}",
                    "name": 'filter_by_mail_content',
                },
                {
                    "type": "string",
                    "label": "#{mailBundle['宛先']}",
                    "name": 'filter_by_receive_address',
                },
                {
                    "type": "string",
                    "label": "#{mailBundle['CC']}",
                    "name": 'filter_by_cc_address',
                },
                {
                    "type": "string",
                    "label": "#{mailBundle['サイズ（KB）']}",
                    "name": 'filter_by_mail_size',
                }
       
            ],
            data: $('.searchDataJson').val(),
            displayQuery: true,
            queryContainer: $("#search-filter").closest('.box.box-search').find('.box-header code'),
            langs:{
                AND: '#{msg['label.condition.and']}',
                OR: '#{msg['label.condition.or']}',
                LIKE: '#{msg['label.condition.like']}',
                LIKE_START: '#{msg['label.condition.like_start']}',
                LIKE_END: '#{msg['label.condition.like_end']}',
                NOT_LIKE: '#{msg['label.condition.not_like']}',
                BLANK: '#{msg['label.condition.blank']}',
                NOT_BLANK: '#{msg['label.condition.not_blank']}'
            }
        };
        
        jQuery(document).ready(function ($) {
            var sf = $("#search-filter").searchFilter(searchFilterOpts);
            
            $(".btn-add").click(function (event) {
                event.preventDefault();
                var data = sf.data('searchFilter').getData();
                $('.searchDataJson').val(data);
                $(".add-action").trigger('click');
            });
            
            $(".btn-update").click(function (event) {
                event.preventDefault();
                var data = sf.data('searchFilter').getData();
                $('.searchDataJson').val(data);
                $(".update-action").trigger('click');
            });
        });
    </h:outputScript>
</ui:composition>